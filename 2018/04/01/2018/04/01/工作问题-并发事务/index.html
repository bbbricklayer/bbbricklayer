<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>工作问题-并发事务 | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="现在开发过程中有个需求，商品没货了需要补货，简略版如下：1、发现商品没货，生成补货单2、如果现在有未处理补货单，先删除当前补货单，之后生成新的补货单，如果当前的补货单已经开始处理，那么忽略3、提供API接口供修改状态 现在数据库设计，状态分为：0：待处理，1：已经认领，2：处理完毕，4：取消简略版数据库如下： 1234567891011create table test.item(	id int">
<meta name="keywords" content="事务,工作,并发">
<meta property="og:type" content="article">
<meta property="og:title" content="工作问题-并发事务">
<meta property="og:url" content="http:&#x2F;&#x2F;yoursite.com&#x2F;2018&#x2F;04&#x2F;01&#x2F;2018&#x2F;04&#x2F;01&#x2F;%E5%B7%A5%E4%BD%9C%E9%97%AE%E9%A2%98-%E5%B9%B6%E5%8F%91%E4%BA%8B%E5%8A%A1&#x2F;index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="现在开发过程中有个需求，商品没货了需要补货，简略版如下：1、发现商品没货，生成补货单2、如果现在有未处理补货单，先删除当前补货单，之后生成新的补货单，如果当前的补货单已经开始处理，那么忽略3、提供API接口供修改状态 现在数据库设计，状态分为：0：待处理，1：已经认领，2：处理完毕，4：取消简略版数据库如下： 1234567891011create table test.item(	id int">
<meta property="og:locale" content="en">
<meta property="og:image" content="http:&#x2F;&#x2F;image.whhxz.smallstool.cn&#x2F;20180408%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A72018-04-01%E4%B8%8B%E5%8D%882.36.31.png">
<meta property="og:updated_time" content="2019-01-04T05:57:37.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http:&#x2F;&#x2F;image.whhxz.smallstool.cn&#x2F;20180408%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A72018-04-01%E4%B8%8B%E5%8D%882.36.31.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-2018/04/01/工作问题-并发事务" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/04/01/2018/04/01/%E5%B7%A5%E4%BD%9C%E9%97%AE%E9%A2%98-%E5%B9%B6%E5%8F%91%E4%BA%8B%E5%8A%A1/" class="article-date">
  <time datetime="2018-04-01T05:53:03.000Z" itemprop="datePublished">2018-04-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%B7%A5%E4%BD%9C%E9%97%AE%E9%A2%98/">工作问题</a>►<a class="article-category-link" href="/categories/%E5%B7%A5%E4%BD%9C%E9%97%AE%E9%A2%98/%E4%BA%8B%E5%8A%A1/">事务</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      工作问题-并发事务
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>现在开发过程中有个需求，商品没货了需要补货，简略版如下：<br>1、发现商品没货，生成补货单<br>2、如果现在有未处理补货单，先删除当前补货单，之后生成新的补货单，如果当前的补货单已经开始处理，那么忽略<br>3、提供API接口供修改状态</p>
<p>现在数据库设计，状态分为：0：待处理，1：已经认领，2：处理完毕，4：取消<br>简略版数据库如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> test.item</span><br><span class="line">(</span><br><span class="line">	<span class="keyword">id</span> <span class="built_in">int</span> auto_increment</span><br><span class="line">		primary <span class="keyword">key</span>,</span><br><span class="line">	sku_code <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">	<span class="keyword">num</span> <span class="built_in">int</span> <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">	<span class="keyword">status</span> <span class="built_in">int</span> <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">	<span class="keyword">constraint</span> item_id_uindex</span><br><span class="line">		<span class="keyword">unique</span> (<span class="keyword">id</span>)</span><br><span class="line">)</span><br><span class="line">;</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="项目验证"><a href="#项目验证" class="headerlink" title="项目验证"></a>项目验证</h3><p>创建Spring项目，配置SpringMVC，Spring、Mybatis</p>
<p>数据库操作如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.whh.mapper.ItemMapper"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--查询列表--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--通过ID查询数据--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"query"</span> <span class="attr">resultType</span>=<span class="string">"com.whh.vo.SearchItemVo"</span>&gt;</span></span><br><span class="line">        select id, sku_code as skuCode,num, status from item</span><br><span class="line">        <span class="tag">&lt;<span class="name">trim</span> <span class="attr">prefix</span>=<span class="string">"where"</span> <span class="attr">suffixOverrides</span>=<span class="string">"and"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"id != null"</span>&gt;</span></span><br><span class="line">                id = #&#123;id&#125; and</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"skuCode != null and skuCode != ''"</span>&gt;</span></span><br><span class="line">                sku_code = #&#123;skuCode&#125; and</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"num != null"</span>&gt;</span></span><br><span class="line">                num = #&#123;num&#125; and</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"status != null"</span>&gt;</span></span><br><span class="line">                status = #&#123;status&#125; and</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"notStatus != null"</span>&gt;</span></span><br><span class="line">                status != #&#123;notStatus&#125; and</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">trim</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--新增数据，插入对象ID会自动设置为自增的ID--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"insert"</span> <span class="attr">parameterType</span>=<span class="string">"com.whh.pojo.Item"</span> <span class="attr">useGeneratedKeys</span>=<span class="string">"true"</span> <span class="attr">keyProperty</span>=<span class="string">"id"</span>&gt;</span></span><br><span class="line">        INSERT INTO item (sku_code,num, status) VALUES (#&#123;skuCode&#125;,#&#123;num&#125;, #&#123;status&#125;)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--关系数据--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"update"</span> <span class="attr">parameterType</span>=<span class="string">"com.whh.pojo.Item"</span>&gt;</span></span><br><span class="line">        update item set</span><br><span class="line">        <span class="tag">&lt;<span class="name">trim</span> <span class="attr">suffixOverrides</span>=<span class="string">","</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"skuCode != null"</span>&gt;</span></span><br><span class="line">                sku_code = #&#123;skuCode&#125;,</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"num != null"</span>&gt;</span></span><br><span class="line">                num = #&#123;num&#125;,</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"status != null"</span>&gt;</span></span><br><span class="line">                status = #&#123;status&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">trim</span>&gt;</span></span><br><span class="line">        where id = #&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>先展示错误的示范：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span>(rollbackFor = Exception<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">int</span> <span class="title">createTask</span>(<span class="title">String</span> <span class="title">skuCode</span>, <span class="title">Integer</span> <span class="title">num</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> result = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//查询数据库是否存在</span></span><br><span class="line">    SearchItemVo params = <span class="keyword">new</span> SearchItemVo();</span><br><span class="line">    params.setSkuCode(skuCode);</span><br><span class="line">    params.setNotStatus(<span class="number">4</span>);</span><br><span class="line">    List&lt;Item&gt; itemList = itemMapper.query(params);</span><br><span class="line">    <span class="comment">//数据库不存在时insert</span></span><br><span class="line">    <span class="keyword">if</span> (itemList == <span class="keyword">null</span> || itemList.isEmpty()) &#123;</span><br><span class="line">        Item item = <span class="keyword">new</span> Item(skuCode, num, <span class="number">0</span>);</span><br><span class="line">        result = itemMapper.insert(item);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Item item = itemList.get(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">//数据库存在，且状态为0，设置状态为4，同时生成新的数据</span></span><br><span class="line">        item.setStatus(<span class="number">4</span>);</span><br><span class="line">        result = itemMapper.update(item);</span><br><span class="line">        <span class="keyword">if</span> (result == <span class="number">1</span>) &#123;</span><br><span class="line">            item.setStatus(<span class="number">0</span>);</span><br><span class="line">            item.setNum(num);</span><br><span class="line">            result = itemMapper.insert(item);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编写Test</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringJUnit4ClassRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">ContextConfiguration</span>(<span class="title">locations</span> </span>= <span class="string">"classpath*:applicationContext.xml"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ItemServiceTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ItemService itemService;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createTask</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Random random = <span class="keyword">new</span> Random();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> num = random.nextInt(<span class="number">100</span>);</span><br><span class="line">            itemService.createTask(<span class="string">"K000001"</span>, num);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>启动Test测试，查询数据库数据。<br><img src="http://image.whhxz.smallstool.cn/20180408%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A72018-04-01%E4%B8%8B%E5%8D%882.36.31.png" alt=""><br>数据库中同一个商品非4状态的只有一条。<br>这样存在一个问题，如果出现并发访问，那么数据库中数据就会查询问题</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">concurrentCreateTask</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String skuCode = <span class="string">"K000001"</span>;</span><br><span class="line">    <span class="keyword">int</span> threadNum = <span class="number">10</span>;</span><br><span class="line">    Thread[] threads = <span class="keyword">new</span> Thread[<span class="number">10</span>];</span><br><span class="line">    CountDownLatch downLatch = <span class="keyword">new</span> CountDownLatch(threadNum);</span><br><span class="line">    <span class="comment">//设置多线程创建</span></span><br><span class="line">    IntStream.range(<span class="number">0</span>, threadNum).forEach((i) -&gt; threads[i] = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">        Random random = <span class="keyword">new</span> Random();</span><br><span class="line">        IntStream.range(<span class="number">0</span>, <span class="number">100</span>).forEach((j) -&gt; itemService.createTask(skuCode, random.nextInt(<span class="number">10</span>)));</span><br><span class="line">        downLatch.countDown();</span><br><span class="line">    &#125;));</span><br><span class="line">    <span class="comment">//启动线程</span></span><br><span class="line">    Arrays.stream(threads).forEach((Thread::start));</span><br><span class="line">    downLatch.await();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//查询验证最终生成的非4数量</span></span><br><span class="line">    SearchItemVo searchItemVo = <span class="keyword">new</span> SearchItemVo();</span><br><span class="line">    searchItemVo.setSkuCode(skuCode);</span><br><span class="line">    searchItemVo.setNotStatus(<span class="number">4</span>);</span><br><span class="line">    List&lt;Item&gt; itemList = itemMapper.query(searchItemVo);</span><br><span class="line">    <span class="keyword">assert</span> itemList != <span class="keyword">null</span> &amp;&amp; itemList.size() == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>启动Test开始测试，结论是肯定的，测试不通过。</p>
<h4 id="分析原因"><a href="#分析原因" class="headerlink" title="分析原因"></a>分析原因</h4><p>因为在代码中，我们是先查询的数据，之后在做的判断，在并发访问时，可能出现多线程同时查询，都为发现数据库无数据，之后执行后续的插入逻辑。后面判断状态也是同理。</p>
<p>解决办法：<br><code>INSERT ... ON DUPLICATE KEY UPDATE</code>，表示如果存在就更新，如果不存在就插入，刚刚好这需求之前的要求。<br>但是此处并不适合这个，因为<code>ON DUPLICATE KEY UPDATE</code>判断重复是依据唯一索引，但是在数据库中，<code>sku_code</code>和<code>status</code>无法建立唯一索引，因为可能会出现一个<code>sku_code</code>对应多个重复的<code>status</code>。</p>
<p>那先解决如果存在在插入数据库。<br>改进sql，在mapper中新增方法</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"insertNotExist"</span> <span class="attr">parameterType</span>=<span class="string">"com.whh.pojo.Item"</span> <span class="attr">useGeneratedKeys</span>=<span class="string">"true"</span> <span class="attr">keyProperty</span>=<span class="string">"id"</span>&gt;</span></span><br><span class="line">    INSERT INTO item (sku_code, num, status) SELECT</span><br><span class="line">                                                #&#123;skuCode&#125;,</span><br><span class="line">                                                #&#123;num&#125;,</span><br><span class="line">                                                #&#123;status&#125;</span><br><span class="line">                                                FROM DUAL</span><br><span class="line">                                                WHERE NOT exists(SELECT id</span><br><span class="line">                                                                FROM item</span><br><span class="line">                                                                WHERE sku_code = #&#123;skuCode&#125; AND status != 4)</span><br><span class="line"><span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>DUAL</code>为临时表。</li>
</ul>
<p>通过查询<code>skuCode</code>和<code>status != 4</code>，使用<code>not exists</code>，获取返回的第一条数据，然后进行插入。</p>
<p>在Mysql中<code>not exists</code>只会返回<code>true</code>或者<code>false</code>，如果返回的是<code>true</code>表示不存在该<code>sku_code</code>且<code>status</code>不为4的数据;反之则返回<code>false</code>，那么将无法插入数据。<br>测试该方法是生效</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Rollback</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertNotExist</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    String skuCode = <span class="string">"K000002"</span>;</span><br><span class="line">    Item item = <span class="keyword">new</span> Item(skuCode, <span class="number">10</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">//判断第一次插入是否成功</span></span><br><span class="line">    <span class="keyword">assert</span> itemMapper.insertNotExist(item) != <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//判断第二次插入是否从</span></span><br><span class="line">    <span class="keyword">assert</span> itemMapper.insertNotExist(item) == <span class="number">0</span>;</span><br><span class="line">    SearchItemVo searchItemVo = <span class="keyword">new</span> SearchItemVo();</span><br><span class="line">    searchItemVo.setNotStatus(<span class="number">4</span>);</span><br><span class="line">    searchItemVo.setSkuCode(skuCode);</span><br><span class="line">    <span class="comment">//判断数据中非4的数据是否只有1条</span></span><br><span class="line">    <span class="keyword">assert</span> itemMapper.query(searchItemVo).size() == <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行单元测试，验证该方法是生效的。</p>
<p>解决了数据只有不存在时才插入。<br>下一步就是如果存在数据状态为0，那么需要修改为4<br>Mapper新增update操作：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"updateInfo"</span>&gt;</span></span><br><span class="line">    UPDATE item set</span><br><span class="line">    <span class="tag">&lt;<span class="name">trim</span> <span class="attr">suffixOverrides</span>=<span class="string">","</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"newInfo.skuCode != null"</span>&gt;</span></span><br><span class="line">            sku_code = #&#123;newInfo.skuCode&#125;,</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"newInfo.num != null"</span>&gt;</span></span><br><span class="line">            num = #&#123;newInfo.num&#125;,</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"newInfo.status != null"</span>&gt;</span></span><br><span class="line">            status = #&#123;newInfo.status&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">trim</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">trim</span> <span class="attr">prefix</span>=<span class="string">"where"</span> <span class="attr">suffixOverrides</span>=<span class="string">"and"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"oldInfo.id != null"</span>&gt;</span></span><br><span class="line">            id = #&#123;oldInfo.id&#125; and</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"oldInfo.skuCode != null"</span>&gt;</span></span><br><span class="line">            sku_code = #&#123;oldInfo.skuCode&#125; and</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"oldInfo.num != null"</span>&gt;</span></span><br><span class="line">            num = #&#123;oldInfo.num&#125; and</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"oldInfo.status != null"</span>&gt;</span></span><br><span class="line">            status = #&#123;oldInfo.status&#125; and</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"oldInfo.id == null and oldInfo.skuCode == null and oldInfo.num == null and oldInfo.status"</span>&gt;</span></span><br><span class="line">            false</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">trim</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>注：最后设置如果传入的查询条件为null，那么就不做更新，避免因为没有查询条件导致更新整张表。</li>
</ul>
<p>在一般情况下，更新时只是通过主键直接更新值，这样在并发情况下会出现多个线程更新，且都更新成功。<br>如：现在一个线程更新状态为4，生成新数据，另一个线程更新状态为1，设置为认领，这样就会导致上一个线程更新后，下一个线程又直接修改了值，导致数据出现错误。<br>所以在处理这种情况时需要加入状态进行判断（CAS）。</p>
<h4 id="改进代码"><a href="#改进代码" class="headerlink" title="改进代码"></a>改进代码</h4><p>修改之前逻辑为新代码，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Transactional(rollbackFor = Exception<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">int</span> <span class="title">createTaskImprove</span>(<span class="title">String</span> <span class="title">skuCode</span>, <span class="title">Integer</span> <span class="title">num</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> result = <span class="number">0</span>;</span><br><span class="line">    Item item = <span class="keyword">new</span> Item(skuCode, num, <span class="number">0</span>);</span><br><span class="line">    result = itemMapper.insertNotExist(item);</span><br><span class="line">    <span class="keyword">if</span> (result == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//构造旧数据用于查询，</span></span><br><span class="line">        Item oldItem = <span class="keyword">new</span> Item(skuCode, <span class="keyword">null</span>, <span class="number">0</span>);</span><br><span class="line">        Item newItem = <span class="keyword">new</span> Item(skuCode, <span class="keyword">null</span>, <span class="number">4</span>);</span><br><span class="line">        result = itemMapper.updateInfo(oldItem, newItem);</span><br><span class="line">        <span class="keyword">if</span> (result != <span class="number">0</span>)&#123;</span><br><span class="line">            result = itemMapper.insertNotExist(item);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>开启并发测试，理论上是应该OK了，但是启动单元测试后，出现了错误。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread &quot;Thread-5&quot; Exception in thread &quot;Thread-9&quot; Exception in thread &quot;Thread-11&quot; org.springframework.dao.DeadlockLoserDataAccessException: </span><br><span class="line">### Error updating database.  Cause: com.mysql.jdbc.exceptions.jdbc4.MySQLTransactionRollbackException: Deadlock found when trying to get lock; try restarting transaction</span><br><span class="line">### The error may involve com.whh.mapper.ItemMapper.insertNotExist-Inline</span><br><span class="line">### The error occurred while setting parameters</span><br><span class="line">### SQL: INSERT INTO item (sku_code, num, status) SELECT                                                    ?,                                                    ?,                                                    ?                                                  FROM DUAL                                                  WHERE NOT exists(SELECT id                                                                   FROM item                                                                   WHERE sku_code = ? AND status != 4)</span><br><span class="line">### Cause: com.mysql.jdbc.exceptions.jdbc4.MySQLTransactionRollbackException: Deadlock found when trying to get lock; try restarting transaction</span><br><span class="line">; SQL []; Deadlock found when trying to get lock; try restarting transaction; nested exception is com.mysql.jdbc.exceptions.jdbc4.MySQLTransactionRollbackException: Deadlock found when trying to get lock; try restarting transaction</span><br><span class="line">	at org.springframework.jdbc.support.SQLErrorCodeSQLExceptionTranslator.doTranslate(SQLErrorCodeSQLExceptionTranslator.java:263)</span><br><span class="line">	at org.springframework.jdbc.support.AbstractFallbackSQLExceptionTranslator.translate(AbstractFallbackSQLExceptionTranslator.java:73)</span><br><span class="line">	at org.mybatis.spring.MyBatisExceptionTranslator.translateExceptionIfPossible(MyBatisExceptionTranslator.java:74)</span><br><span class="line">	at org.mybatis.spring.SqlSessionTemplate$SqlSessionInterceptor.invoke(SqlSessionTemplate.java:421)</span><br><span class="line">	at com.sun.proxy.$Proxy20.insert(Unknown Source)</span><br><span class="line">	at org.mybatis.spring.SqlSessionTemplate.insert(SqlSessionTemplate.java:254)</span><br><span class="line">	at org.apache.ibatis.binding.MapperMethod.execute(MapperMethod.java:52)</span><br><span class="line">	at org.apache.ibatis.binding.MapperProxy.invoke(MapperProxy.java:53)</span><br><span class="line">	at com.sun.proxy.$Proxy24.insertNotExist(Unknown Source)</span><br><span class="line">	at com.whh.service.ItemService.createTaskImprove(ItemService.java:66)</span><br><span class="line">	at com.whh.service.ItemService$$FastClassBySpringCGLIB$$a83be025.invoke(&lt;generated&gt;)</span><br><span class="line">	at org.springframework.cglib.proxy.MethodProxy.invoke(MethodProxy.java:204)</span><br><span class="line">	at org.springframework.aop.framework.CglibAopProxy$DynamicAdvisedInterceptor.intercept(CglibAopProxy.java:651)</span><br><span class="line">	at com.whh.service.ItemService$$EnhancerBySpringCGLIB$$bc7432b6.createTaskImprove(&lt;generated&gt;)</span><br><span class="line">	at com.whh.service.ItemServiceTest.lambda$null$3(ItemServiceTest.java:80)</span><br><span class="line">	at java.util.stream.Streams$RangeIntSpliterator.forEachRemaining(Streams.java:110)</span><br><span class="line">	at java.util.stream.IntPipeline$Head.forEach(IntPipeline.java:557)</span><br><span class="line">	at com.whh.service.ItemServiceTest.lambda$null$4(ItemServiceTest.java:80)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:745)</span><br><span class="line">Caused by: com.mysql.jdbc.exceptions.jdbc4.MySQLTransactionRollbackException: Deadlock found when trying to get lock; try restarting transaction</span><br><span class="line">	at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)</span><br><span class="line">	at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:62)</span><br><span class="line">	at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)</span><br><span class="line">	at java.lang.reflect.Constructor.newInstance(Constructor.java:422)</span><br><span class="line">	at com.mysql.jdbc.Util.handleNewInstance(Util.java:409)</span><br><span class="line">	at com.mysql.jdbc.Util.getInstance(Util.java:384)</span><br><span class="line">	at com.mysql.jdbc.SQLError.createSQLException(SQLError.java:1064)</span><br><span class="line">	at com.mysql.jdbc.MysqlIO.checkErrorPacket(MysqlIO.java:4232)</span><br><span class="line">	at com.mysql.jdbc.MysqlIO.checkErrorPacket(MysqlIO.java:4164)</span><br><span class="line">	at com.mysql.jdbc.MysqlIO.sendCommand(MysqlIO.java:2615)</span><br><span class="line">	at com.mysql.jdbc.MysqlIO.sqlQueryDirect(MysqlIO.java:2776)</span><br><span class="line">	at com.mysql.jdbc.ConnectionImpl.execSQL(ConnectionImpl.java:2838)</span><br><span class="line">	at com.mysql.jdbc.PreparedStatement.executeInternal(PreparedStatement.java:2082)</span><br><span class="line">	at com.mysql.jdbc.PreparedStatement.execute(PreparedStatement.java:1307)</span><br><span class="line">	at com.alibaba.druid.filter.FilterChainImpl.preparedStatement_execute(FilterChainImpl.java:2931)</span><br><span class="line">	at com.alibaba.druid.filter.FilterEventAdapter.preparedStatement_execute(FilterEventAdapter.java:440)</span><br><span class="line">	at com.alibaba.druid.filter.FilterChainImpl.preparedStatement_execute(FilterChainImpl.java:2929)</span><br><span class="line">	at com.alibaba.druid.filter.FilterEventAdapter.preparedStatement_execute(FilterEventAdapter.java:440)</span><br><span class="line">	at com.alibaba.druid.filter.FilterChainImpl.preparedStatement_execute(FilterChainImpl.java:2929)</span><br><span class="line">	at com.alibaba.druid.proxy.jdbc.PreparedStatementProxyImpl.execute(PreparedStatementProxyImpl.java:131)</span><br><span class="line">	at com.alibaba.druid.pool.DruidPooledPreparedStatement.execute(DruidPooledPreparedStatement.java:493)</span><br><span class="line">	at sun.reflect.GeneratedMethodAccessor23.invoke(Unknown Source)</span><br><span class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line">	at java.lang.reflect.Method.invoke(Method.java:497)</span><br><span class="line">	at org.apache.ibatis.logging.jdbc.PreparedStatementLogger.invoke(PreparedStatementLogger.java:59)</span><br><span class="line">	at com.sun.proxy.$Proxy27.execute(Unknown Source)</span><br><span class="line">	at org.apache.ibatis.executor.statement.PreparedStatementHandler.update(PreparedStatementHandler.java:45)</span><br><span class="line">	at org.apache.ibatis.executor.statement.RoutingStatementHandler.update(RoutingStatementHandler.java:73)</span><br><span class="line">	at org.apache.ibatis.executor.SimpleExecutor.doUpdate(SimpleExecutor.java:49)</span><br><span class="line">	at org.apache.ibatis.executor.BaseExecutor.update(BaseExecutor.java:115)</span><br><span class="line">	at org.apache.ibatis.executor.CachingExecutor.update(CachingExecutor.java:75)</span><br><span class="line">	at org.apache.ibatis.session.defaults.DefaultSqlSession.update(DefaultSqlSession.java:170)</span><br><span class="line">	at org.apache.ibatis.session.defaults.DefaultSqlSession.insert(DefaultSqlSession.java:157)</span><br><span class="line">	at sun.reflect.GeneratedMethodAccessor27.invoke(Unknown Source)</span><br><span class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line">	at java.lang.reflect.Method.invoke(Method.java:497)</span><br><span class="line">	at org.mybatis.spring.SqlSessionTemplate$SqlSessionInterceptor.invoke(SqlSessionTemplate.java:408)</span><br><span class="line">	... 15 more</span><br></pre></td></tr></table></figure>
<p>从错误上看，出现了死锁，通过命令<code>show engine innodb status;</code>查询数据库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">=====================================</span><br><span class="line">2018-04-01 19:17:11 700003efe000 INNODB MONITOR OUTPUT</span><br><span class="line">=====================================</span><br><span class="line">Per second averages calculated from the last 32 seconds</span><br><span class="line">-----------------</span><br><span class="line">BACKGROUND THREAD</span><br><span class="line">-----------------</span><br><span class="line">srv_master_thread loops: 84 srv_active, 0 srv_shutdown, 24429 srv_idle</span><br><span class="line">srv_master_thread log flush and writes: 24513</span><br><span class="line">----------</span><br><span class="line">SEMAPHORES</span><br><span class="line">----------</span><br><span class="line">OS WAIT ARRAY INFO: reservation count 474</span><br><span class="line">OS WAIT ARRAY INFO: signal count 548</span><br><span class="line">Mutex spin waits 10228, rounds 38291, OS waits 49</span><br><span class="line">RW-shared spins 1411, rounds 29858, OS waits 247</span><br><span class="line">RW-excl spins 201, rounds 6233, OS waits 70</span><br><span class="line">Spin rounds per wait: 3.74 mutex, 21.16 RW-shared, 31.01 RW-excl</span><br><span class="line">------------------------</span><br><span class="line">LATEST DETECTED DEADLOCK</span><br><span class="line">------------------------</span><br><span class="line">2018-04-01 19:17:02 700003fca000</span><br><span class="line">*** (1) TRANSACTION:</span><br><span class="line">TRANSACTION 170407, ACTIVE 0 sec setting auto-inc lock</span><br><span class="line">mysql tables in use 2, locked 2</span><br><span class="line">LOCK WAIT 4 lock struct(s), heap size 1184, 300 row lock(s)</span><br><span class="line">MySQL thread id 2659, OS thread handle 0x700003cde000, query id 49518 localhost 127.0.0.1 root executing</span><br><span class="line">INSERT INTO item (sku_code, num, status) SELECT</span><br><span class="line">                                                   &apos;K000001&apos;,</span><br><span class="line">                                                   2,</span><br><span class="line">                                                   0</span><br><span class="line">                                                 FROM DUAL</span><br><span class="line">                                                 WHERE NOT exists(SELECT id</span><br><span class="line">                                                                  FROM item</span><br><span class="line">                                                                  WHERE sku_code = &apos;K000001&apos; AND status != 4)</span><br><span class="line">*** (1) WAITING FOR THIS LOCK TO BE GRANTED:</span><br><span class="line">TABLE LOCK table `test`.`item` trx id 170407 lock mode AUTO-INC waiting</span><br><span class="line">*** (2) TRANSACTION:</span><br><span class="line">TRANSACTION 170402, ACTIVE 0 sec inserting</span><br><span class="line">mysql tables in use 2, locked 2</span><br><span class="line">7 lock struct(s), heap size 1184, 303 row lock(s)</span><br><span class="line">MySQL thread id 2660, OS thread handle 0x700003fca000, query id 49503 localhost 127.0.0.1 root executing</span><br><span class="line">INSERT INTO item (sku_code, num, status) SELECT</span><br><span class="line">                                                   &apos;K000001&apos;,</span><br><span class="line">                                                   4,</span><br><span class="line">                                                   0</span><br><span class="line">                                                 FROM DUAL</span><br><span class="line">                                                 WHERE NOT exists(SELECT id</span><br><span class="line">                                                                  FROM item</span><br><span class="line">                                                                  WHERE sku_code = &apos;K000001&apos; AND status != 4)</span><br><span class="line">*** (2) HOLDS THE LOCK(S):</span><br><span class="line">TABLE LOCK table `test`.`item` trx id 170402 lock mode AUTO-INC</span><br><span class="line">*** (2) WAITING FOR THIS LOCK TO BE GRANTED:</span><br><span class="line">RECORD LOCKS space id 96 page no 3 n bits 368 index `PRIMARY` of table `test`.`item` trx id 170402 lock_mode X insert intention waiting</span><br><span class="line">Record lock, heap no 1 PHYSICAL RECORD: n_fields 1; compact format; info bits 0</span><br><span class="line"> 0: len 8; hex 73757072656d756d; asc supremum;;</span><br><span class="line"></span><br><span class="line">*** WE ROLL BACK TRANSACTION (1)</span><br><span class="line">------------</span><br><span class="line">TRANSACTIONS</span><br><span class="line">------------</span><br><span class="line">Trx id counter 170788</span><br><span class="line">Purge done for trx&apos;s n:o &lt; 170787 undo n:o &lt; 0 state: running but idle</span><br><span class="line">History list length 1521</span><br><span class="line">LIST OF TRANSACTIONS FOR EACH SESSION:</span><br><span class="line">---TRANSACTION 170407, not started</span><br><span class="line">MySQL thread id 2659, OS thread handle 0x700003cde000, query id 49518 localhost 127.0.0.1 root cleaning up</span><br><span class="line">---TRANSACTION 170404, not started</span><br><span class="line">MySQL thread id 2661, OS thread handle 0x700003dee000, query id 49513 localhost 127.0.0.1 root cleaning up</span><br><span class="line">---TRANSACTION 170408, not started</span><br><span class="line">MySQL thread id 2660, OS thread handle 0x700003fca000, query id 49546 localhost 127.0.0.1 root cleaning up</span><br><span class="line">---TRANSACTION 170296, not started</span><br><span class="line">MySQL thread id 2666, OS thread handle 0x700003e76000, query id 49252 localhost 127.0.0.1 root cleaning up</span><br><span class="line">---TRANSACTION 170401, not started</span><br><span class="line">MySQL thread id 2658, OS thread handle 0x700003d66000, query id 49500 localhost 127.0.0.1 root cleaning up</span><br><span class="line">---TRANSACTION 170311, not started</span><br><span class="line">MySQL thread id 2667, OS thread handle 0x700003f42000, query id 49284 localhost 127.0.0.1 root cleaning up</span><br><span class="line">---TRANSACTION 170787, not started</span><br><span class="line">MySQL thread id 2663, OS thread handle 0x700003d22000, query id 50365 localhost 127.0.0.1 root cleaning up</span><br><span class="line">---TRANSACTION 170403, not started</span><br><span class="line">MySQL thread id 2662, OS thread handle 0x700003f86000, query id 49512 localhost 127.0.0.1 root cleaning up</span><br><span class="line">---TRANSACTION 170320, not started</span><br><span class="line">MySQL thread id 2665, OS thread handle 0x700003eba000, query id 49308 localhost 127.0.0.1 root cleaning up</span><br><span class="line">---TRANSACTION 170405, not started</span><br><span class="line">MySQL thread id 2664, OS thread handle 0x700003daa000, query id 49514 localhost 127.0.0.1 root cleaning up</span><br><span class="line">---TRANSACTION 168759, not started</span><br><span class="line">MySQL thread id 2507, OS thread handle 0x700003efe000, query id 50372 localhost 127.0.0.1 root init</span><br><span class="line">show engine innodb status</span><br><span class="line">---TRANSACTION 169405, not started</span><br><span class="line">MySQL thread id 2498, OS thread handle 0x700003e32000, query id 46830 localhost 127.0.0.1 root cleaning up</span><br><span class="line">--------</span><br><span class="line">FILE I/O</span><br><span class="line">--------</span><br><span class="line">I/O thread 0 state: waiting for i/o request (insert buffer thread)</span><br><span class="line">I/O thread 1 state: waiting for i/o request (log thread)</span><br><span class="line">I/O thread 2 state: waiting for i/o request (read thread)</span><br><span class="line">I/O thread 3 state: waiting for i/o request (read thread)</span><br><span class="line">I/O thread 4 state: waiting for i/o request (read thread)</span><br><span class="line">I/O thread 5 state: waiting for i/o request (read thread)</span><br><span class="line">I/O thread 6 state: waiting for i/o request (write thread)</span><br><span class="line">I/O thread 7 state: waiting for i/o request (write thread)</span><br><span class="line">I/O thread 8 state: waiting for i/o request (write thread)</span><br><span class="line">I/O thread 9 state: waiting for i/o request (write thread)</span><br><span class="line">Pending normal aio reads: 0 [0, 0, 0, 0] , aio writes: 0 [0, 0, 0, 0] ,</span><br><span class="line"> ibuf aio reads: 0, log i/o&apos;s: 0, sync i/o&apos;s: 0</span><br><span class="line">Pending flushes (fsync) log: 0; buffer pool: 0</span><br><span class="line">631 OS file reads, 5249 OS file writes, 4212 OS fsyncs</span><br><span class="line">0.00 reads/s, 0 avg bytes/read, 11.03 writes/s, 7.66 fsyncs/s</span><br><span class="line">-------------------------------------</span><br><span class="line">INSERT BUFFER AND ADAPTIVE HASH INDEX</span><br><span class="line">-------------------------------------</span><br><span class="line">Ibuf: size 1, free list len 0, seg size 2, 0 merges</span><br><span class="line">merged operations:</span><br><span class="line"> insert 0, delete mark 0, delete 0</span><br><span class="line">discarded operations:</span><br><span class="line"> insert 0, delete mark 0, delete 0</span><br><span class="line">Hash table size 276671, node heap has 1 buffer(s)</span><br><span class="line">7.12 hash searches/s, 1.25 non-hash searches/s</span><br><span class="line">---</span><br><span class="line">LOG</span><br><span class="line">---</span><br><span class="line">Log sequence number 5988246706</span><br><span class="line">Log flushed up to   5988246706</span><br><span class="line">Pages flushed up to 5988246706</span><br><span class="line">Last checkpoint at  5988246706</span><br><span class="line">0 pending log writes, 0 pending chkp writes</span><br><span class="line">3847 log i/o&apos;s done, 7.38 log i/o&apos;s/second</span><br><span class="line">----------------------</span><br><span class="line">BUFFER POOL AND MEMORY</span><br><span class="line">----------------------</span><br><span class="line">Total memory allocated 137363456; in additional pool allocated 0</span><br><span class="line">Dictionary memory allocated 174719</span><br><span class="line">Buffer pool size   8191</span><br><span class="line">Free buffers       7672</span><br><span class="line">Database pages     518</span><br><span class="line">Old database pages 209</span><br><span class="line">Modified db pages  0</span><br><span class="line">Pending reads 0</span><br><span class="line">Pending writes: LRU 0, flush list 0, single page 0</span><br><span class="line">Pages made young 0, not young 0</span><br><span class="line">0.00 youngs/s, 0.00 non-youngs/s</span><br><span class="line">Pages read 446, created 72, written 2372</span><br><span class="line">0.00 reads/s, 0.03 creates/s, 9.19 writes/s</span><br><span class="line">Buffer pool hit rate 1000 / 1000, young-making rate 0 / 1000 not 0 / 1000</span><br><span class="line">Pages read ahead 0.00/s, evicted without access 0.00/s, Random read ahead 0.00/s</span><br><span class="line">LRU len: 518, unzip_LRU len: 0</span><br><span class="line">I/O sum[0]:cur[0], unzip sum[0]:cur[0]</span><br><span class="line">--------------</span><br><span class="line">ROW OPERATIONS</span><br><span class="line">--------------</span><br><span class="line">0 queries inside InnoDB, 0 queries in queue</span><br><span class="line">0 read views open inside InnoDB</span><br><span class="line">Main thread id 123145362894848, state: sleeping</span><br><span class="line">Number of rows inserted 2531, updated 2545, deleted 2095, read 1304134</span><br><span class="line">3.62 inserts/s, 3.62 updates/s, 0.00 deletes/s, 4112.25 reads/s</span><br><span class="line">----------------------------</span><br><span class="line">END OF INNODB MONITOR OUTPUT</span><br><span class="line">============================</span><br></pre></td></tr></table></figure>

<p>重现deadlock。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> item (sku_code, <span class="keyword">num</span>, <span class="keyword">status</span>) <span class="keyword">SELECT</span></span><br><span class="line">                                           <span class="string">'K000001'</span>,</span><br><span class="line">                                           <span class="number">8</span>,</span><br><span class="line">                                           <span class="number">0</span></span><br><span class="line">                                         <span class="keyword">FROM</span> DUAL</span><br><span class="line">                                         <span class="keyword">WHERE</span> <span class="keyword">NOT</span> <span class="keyword">exists</span>(<span class="keyword">SELECT</span> <span class="keyword">id</span></span><br><span class="line">                                                          <span class="keyword">FROM</span> item</span><br><span class="line">                                                          <span class="keyword">WHERE</span> sku_code = <span class="string">'K000001'</span> <span class="keyword">AND</span> <span class="keyword">status</span> != <span class="number">4</span>);</span><br></pre></td></tr></table></figure>
<p>现在数据库中没有改条数据，启动3个session，设置事务不自动提交。步骤：<br>1、session1，执行sql，输入插入一条数据，但是事务未提交<br>2、seesion2，执行sql，<br>3、session3，执行sql，<br>4、session1回滚，这时就会发现session3中出现了deadlock。</p>
<p>参考：<a href="http://www.ywnds.com/?p=11093" target="_blank" rel="noopener">两个INSERT发生死锁原因剖析</a></p>
<p>解决办法，修改SQL如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;insert id="insertNotExist" parameterType="com.whh.pojo.Item" useGeneratedKeys="true" keyProperty="id"&gt;</span><br><span class="line">    <span class="keyword">INSERT</span> <span class="keyword">DELAYED</span> <span class="keyword">INTO</span> item (sku_code, <span class="keyword">num</span>, <span class="keyword">status</span>) <span class="keyword">SELECT</span></span><br><span class="line">                                                <span class="comment">#&#123;skuCode&#125;,</span></span><br><span class="line">                                                <span class="comment">#&#123;num&#125;,</span></span><br><span class="line">                                                <span class="comment">#&#123;status&#125;</span></span><br><span class="line">                                                <span class="keyword">FROM</span> DUAL</span><br><span class="line">                                                <span class="keyword">WHERE</span> <span class="keyword">NOT</span> <span class="keyword">exists</span>(<span class="keyword">SELECT</span> <span class="keyword">id</span></span><br><span class="line">                                                                <span class="keyword">FROM</span> item</span><br><span class="line">                                                                <span class="keyword">WHERE</span> sku_code = <span class="comment">#&#123;skuCode&#125; AND status != 4 for update)</span></span><br><span class="line">&lt;/<span class="keyword">insert</span>&gt;</span><br></pre></td></tr></table></figure>
<p>在select的后面添加<code>for update</code>，用于锁住数据，避免发生竞争导致死锁。这里通过上述启动3个事务方便执行，然后回滚的例子，并不会出现deadlock。</p>
<ul>
<li>此处需要添加索引，因为<code>for update</code>默认通过索引来锁数据。</li>
</ul>
<p>重新运行单元测试，启动正常。</p>
<p>此处记录一个未解问题：<br>之前想优化下此处逻辑，先直接更新状态0–&gt;4，然后在插入。如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span>()</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">createTaskImprove1</span><span class="params">(String skuCode, Integer num)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> result = <span class="number">0</span>;</span><br><span class="line">    Item oldItem = <span class="keyword">new</span> Item(skuCode, <span class="keyword">null</span>, <span class="number">0</span>);</span><br><span class="line">    Item newItem = <span class="keyword">new</span> Item(skuCode, <span class="keyword">null</span>, <span class="number">4</span>);</span><br><span class="line">    result = itemMapper.updateInfo(oldItem, newItem);</span><br><span class="line"></span><br><span class="line">    Item item = <span class="keyword">new</span> Item(skuCode, num, <span class="number">0</span>);</span><br><span class="line">    result = itemMapper.insertNotExist(item);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此处在并发的时候是有问题的（业务也有问题，会出现数据丢失的情况），还是会出现死锁，难道是因为使用<code>update</code>的时候数据库的锁和<code>insert ... select</code>设置的锁，导致互锁？暂时还未弄明白。</p>
<p>解决上述问题后，又出现一个问题，当并发执行<code>insert ... select</code>时，其他线程会等待该线程事务提交后才会执行，这样就会导致效率很低。<br>通过sql</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> r.trx_isolation_level, r.trx_id waiting_trx_id,r.trx_mysql_thread_id waiting_trx_thread,</span><br><span class="line">                              r.trx_state waiting_trx_state,lr.lock_mode waiting_trx_lock_mode,lr.lock_type waiting_trx_lock_type,</span><br><span class="line">                              lr.lock_table waiting_trx_lock_table,lr.lock_index waiting_trx_lock_index,r.trx_query waiting_trx_query,</span><br><span class="line">                              b.trx_id blocking_trx_id,b.trx_mysql_thread_id blocking_trx_thread,b.trx_state blocking_trx_state,</span><br><span class="line">                              lb.lock_mode blocking_trx_lock_mode,lb.lock_type blocking_trx_lock_type,lb.lock_table blocking_trx_lock_table,</span><br><span class="line">                              lb.lock_index blocking_trx_lock_index,b.trx_query blocking_query</span><br><span class="line"><span class="keyword">from</span> information_schema.innodb_lock_waits w <span class="keyword">inner</span> <span class="keyword">join</span> information_schema.innodb_trx b <span class="keyword">on</span> b.trx_id=w.blocking_trx_id</span><br><span class="line">  <span class="keyword">inner</span> <span class="keyword">join</span> information_schema.innodb_trx r <span class="keyword">on</span> r.trx_id=w.requesting_trx_id</span><br><span class="line">  <span class="keyword">inner</span> <span class="keyword">join</span> information_schema.innodb_locks lb <span class="keyword">on</span> lb.lock_trx_id=w.blocking_trx_id</span><br><span class="line">  <span class="keyword">inner</span> <span class="keyword">join</span> information_schema.innodb_locks lr <span class="keyword">on</span> lr.lock_trx_id=w.requesting_trx_id</span><br></pre></td></tr></table></figure>
<p>这样可以查询出等待的锁，可以得出锁住的是之前创建的索引。</p>
<p>在测试的时候，因为每次都是直接删除掉数据库数据后进行操作的，这样就会出现上述的等待锁的情况。后来发现当我数据库中存在<code>K000006</code>数据时，两个事物分别插入<code>K000001</code>和<code>K000007</code>并不会出现锁等待，提交事务后数据都插入了数据库，后来实验分别插入<code>K000006</code>两边的数据，结果都未发现锁等待的情况。这里猜测应该是数据库中索引使用的是<code>B+Tree</code>结构。这时删掉之前建立的索引，都会导致锁等待。</p>
<h3 id="分布式流水号"><a href="#分布式流水号" class="headerlink" title="分布式流水号"></a>分布式流水号</h3><p>在应用生成分布式流水号，有两种方式，一种是通过数据表生成，一种是通过缓存生成。</p>
<h4 id="Mysql生成流水号"><a href="#Mysql生成流水号" class="headerlink" title="Mysql生成流水号"></a>Mysql生成流水号</h4><p>在原先生成分布式流水号是通过先<code>select ... for update</code>来锁定数据库中某条值，之后对该值进行更新操作，这种就会出现一个问题，如果刚刚开始数据库就没有值，并发访问时，会出现同时对数据进行插入操作。如果建立了唯一索引数据并不会出现问题。</p>
<p>设计数据库表如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> test.serial_number</span><br><span class="line">(</span><br><span class="line">	group_code <span class="built_in">varchar</span>(<span class="number">10</span>) <span class="literal">null</span> <span class="keyword">comment</span> <span class="string">'组，用于区分业务'</span>,</span><br><span class="line">	group_key <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">comment</span> <span class="string">'依据key生成流水号'</span>,</span><br><span class="line">	<span class="keyword">scope</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">comment</span> <span class="string">'范围，如20180808表示天，2018080808表示小时'</span>,</span><br><span class="line">	<span class="keyword">sign</span> <span class="built_in">varchar</span>(<span class="number">5</span>) <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">comment</span> <span class="string">'重新计算标示，Y年，M月，D天，H小时，G全局'</span>,</span><br><span class="line">	<span class="keyword">num</span> <span class="built_in">int</span> <span class="keyword">default</span> <span class="string">'0'</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">comment</span> <span class="string">'流水号'</span>,</span><br><span class="line">	<span class="keyword">constraint</span> serial_number_group_code_group_key_scope_step_uindex</span><br><span class="line">		<span class="keyword">unique</span> (group_code, group_key, <span class="keyword">scope</span>, <span class="keyword">sign</span>)</span><br><span class="line">)</span><br><span class="line">;</span><br></pre></td></tr></table></figure>
<p>创建表，同时对<code>group_code、group_key、scope、sign、num</code>建立唯一索引。<br>mapper创建db操作：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"insertWithUpdateIncr"</span>&gt;</span></span><br><span class="line">    INSERT INTO serial_number (group_code, group_key, scope, sign, num)</span><br><span class="line">    VALUES (#&#123;serialNumber.groupCode&#125;, #&#123;serialNumber.groupKey&#125;, #&#123;serialNumber.scope&#125;, #&#123;serialNumber.sign&#125;, #&#123;inrc&#125;)</span><br><span class="line">    ON DUPLICATE KEY UPDATE num = num + #&#123;inrc&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectNum"</span> <span class="attr">parameterType</span>=<span class="string">"com.whh.pojo.SerialNumber"</span> <span class="attr">resultType</span>=<span class="string">"java.lang.Integer"</span>&gt;</span></span><br><span class="line">    SELECT num</span><br><span class="line">    FROM serial_number</span><br><span class="line">            WHERE</span><br><span class="line">        group_code = #&#123;groupCode&#125;</span><br><span class="line">        AND group_key = #&#123;groupKey&#125;</span><br><span class="line">        AND scope = #&#123;scope&#125;</span><br><span class="line">        AND sign = #&#123;sign&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>insertWithUpdateIncr</code>用来对数据进行更新和插入操作，如果存在指定数据，那么就对数据进行更新，更新的值为传入的值为原始值+传入值，如果不存在该数据，那么对该数据进行插入操作。（数据库默认num为0，为了避免生成默认值，需要在插入时指定传入的值，可以避免数据获取失败）<br><code>selectNum</code>用于插入更新后，查询数据库最新值。</p>
<p>创建映射对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SerialNumber</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String groupCode;</span><br><span class="line">    <span class="keyword">private</span> String groupKey;</span><br><span class="line">    <span class="keyword">private</span> String scope;</span><br><span class="line">    <span class="keyword">private</span> SerialSignEnum sign;</span><br><span class="line">    <span class="keyword">private</span> Integer num;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> SerialSignEnum &#123;</span><br><span class="line">    G(<span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">scope</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    Y(<span class="number">366</span> * <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span>) &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">scope</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy"</span>).format(<span class="keyword">new</span> Date());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    M(<span class="number">32</span> * <span class="number">24</span> * <span class="number">60</span> * <span class="number">6</span>) &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">scope</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyyMM"</span>).format(<span class="keyword">new</span> Date());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;,</span><br><span class="line">    D(<span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span>) &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">scope</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyyMMdd"</span>).format(<span class="keyword">new</span> Date());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    H(<span class="number">60</span> * <span class="number">60</span>) &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">scope</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyyMMdd"</span>).format(<span class="keyword">new</span> Date());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer expire;</span><br><span class="line"></span><br><span class="line">    SerialSignEnum(Integer expire) &#123;</span><br><span class="line">        <span class="keyword">this</span>.expire = expire;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getExpire</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> expire;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setExpire</span><span class="params">(Integer expire)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.expire = expire;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> String <span class="title">scope</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建service进行操作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SerialNumberService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SerialNumberMapper serialNumberMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span>(propagation = Propagation.REQUIRES_NEW,rollbackFor = Exception<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">Integer</span> <span class="title">mysqlSerialNumber</span>(<span class="title">SerialNumber</span> <span class="title">serialNumber</span>, <span class="title">int</span> <span class="title">inrc</span>) </span>&#123;</span><br><span class="line">        serialNumberMapper.insertWithUpdateIncr(serialNumber, inrc);</span><br><span class="line">        <span class="keyword">return</span> serialNumberMapper.selectNum(serialNumber);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如上，直接对数据库数据进行插入更新操作，之后对数据进行查询，获取最新值。<br>这种在并发的时候也保证数据正常是因为之前设置了唯一索引，在对数据进行插入更新操作时会对当前数据进行加锁，此时如果存在其他事务中对该数据进行操作就会进入锁等待，直到上个事务释放锁，所以之后的查询操作保证了数据为当前更新后的最新值。如果是对不同数据进行操作，不会发生锁竞争。<br>注：此处事务传播级别采用的是<code>Propagation.REQUIRES_NEW</code>，创建一个于原先事务无关的事务，这样避免了因调用端事务执行时间过长导致其他线程一直等待。这种缺点在于如果在调用生成流水号后调用方出现异常，那么会导致序列化不连续。</p>
<p>编写单元测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringJUnit4ClassRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">ContextConfiguration</span>(<span class="title">locations</span> </span>= <span class="string">"classpath*:applicationContext.xml"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SerialNumberServiceTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SerialNumberService serialNumberService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SerialNumberMapper serialNumberMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">mysqlSerialNumber</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> SerialNumber serialNumber = <span class="keyword">new</span> SerialNumber(<span class="string">"ITEM"</span>, <span class="string">"1001_K000011"</span>, SerialSignEnum.D);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> incr = <span class="number">1</span>;</span><br><span class="line">        Integer oldNum = serialNumberMapper.selectNum(serialNumber);</span><br><span class="line">        <span class="keyword">if</span> (oldNum == <span class="keyword">null</span>)oldNum =<span class="number">0</span>;</span><br><span class="line">        serialNumberService.mysqlSerialNumber(serialNumber, incr);</span><br><span class="line">        <span class="keyword">assert</span> serialNumberMapper.selectNum(serialNumber) == oldNum + incr;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">mysqlSerialNumberSingleKey</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> startTime = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">final</span> SerialNumber serialNumber = <span class="keyword">new</span> SerialNumber(<span class="string">"ITEM"</span>, <span class="string">"1001_K00005"</span>, SerialSignEnum.D);</span><br><span class="line">        Integer oldNum = serialNumberMapper.selectNum(serialNumber);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> incr = <span class="number">10</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> threadNum = <span class="number">10</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> threadTime = <span class="number">100</span>;</span><br><span class="line">        Thread[] threads = <span class="keyword">new</span> Thread[threadNum];</span><br><span class="line">        CountDownLatch downLatch = <span class="keyword">new</span> CountDownLatch(threadNum);</span><br><span class="line"></span><br><span class="line">        Integer[] serialNums = <span class="keyword">new</span> Integer[threadNum * threadTime];</span><br><span class="line">        IntStream.range(<span class="number">0</span>, threadNum).forEach((i) -&gt; threads[i] = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="comment">//线程并发执行，返回值存入集合，空间换时间</span></span><br><span class="line">            IntStream.range(<span class="number">0</span>, threadTime).forEach((j) -&gt; serialNums[i * threadTime + j] = serialNumberService.mysqlSerialNumber(serialNumber, incr));</span><br><span class="line">            downLatch.countDown();</span><br><span class="line">        &#125;));</span><br><span class="line">        Arrays.stream(threads).forEach(Thread::start);</span><br><span class="line">        downLatch.await();</span><br><span class="line">        System.out.println(<span class="string">"耗时："</span> + (System.currentTimeMillis() - startTime));</span><br><span class="line">        <span class="comment">//验证最终值是否和理想一致</span></span><br><span class="line">        <span class="keyword">assert</span> serialNumberMapper.selectNum(serialNumber) == oldNum + threadNum * threadTime * incr;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//验证是否重复生成</span></span><br><span class="line">        Set&lt;Integer&gt; set = <span class="keyword">new</span> HashSet&lt;&gt;(Arrays.asList(serialNums));</span><br><span class="line">        <span class="keyword">assert</span> set.size() == serialNums.length;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">mysqlSerialNumberRandomKey</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> startTime = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> incr = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> threadNum = <span class="number">10</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> threadTime = <span class="number">1000</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> itemNum = <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> SerialNumber[] serialNumbers = <span class="keyword">new</span> SerialNumber[itemNum];</span><br><span class="line">        CountDownLatch downLatch = <span class="keyword">new</span> CountDownLatch(threadNum);</span><br><span class="line">        <span class="comment">//随机设置值</span></span><br><span class="line">        IntStream.range(<span class="number">0</span>, itemNum).forEach((i) -&gt;&#123;</span><br><span class="line">            Random random = <span class="keyword">new</span> Random();</span><br><span class="line">            DecimalFormat format = <span class="keyword">new</span> DecimalFormat(<span class="string">"00000"</span>);</span><br><span class="line">            serialNumbers[i] = <span class="keyword">new</span> SerialNumber(<span class="string">"ITEM"</span>, <span class="string">"1001_K"</span> + format.format(random.nextInt(itemNum) + <span class="number">1</span>), SerialSignEnum.D);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//记录线程返回值</span></span><br><span class="line">        <span class="keyword">final</span> Integer[] signNums = <span class="keyword">new</span> Integer[threadNum * threadTime];</span><br><span class="line">        <span class="comment">//记录线程请求</span></span><br><span class="line">        <span class="keyword">final</span> SerialNumber[] signSerialNumbers = <span class="keyword">new</span> SerialNumber[threadNum * threadTime];</span><br><span class="line">        <span class="keyword">final</span> Thread[] threads = <span class="keyword">new</span> Thread[threadNum];</span><br><span class="line">        IntStream.range(<span class="number">0</span>, threadNum).forEach((i) -&gt; threads[i] = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            IntStream.range(<span class="number">0</span>, threadTime).forEach((j) -&gt; &#123;</span><br><span class="line">                <span class="comment">//线程随机选择需要执行条件</span></span><br><span class="line">                Random random = <span class="keyword">new</span> Random();</span><br><span class="line">                SerialNumber serialNumber = serialNumbers[random.nextInt(<span class="number">20</span>)];</span><br><span class="line">                <span class="comment">//记录执行的请求、返回值</span></span><br><span class="line">                signNums[i * threadTime + j] = serialNumberService.mysqlSerialNumber(serialNumber, incr);</span><br><span class="line">                signSerialNumbers[i * threadTime + j] = serialNumber;</span><br><span class="line">            &#125;);</span><br><span class="line">            downLatch.countDown();</span><br><span class="line">        &#125;));</span><br><span class="line">        Arrays.stream(threads).forEach(Thread::start);</span><br><span class="line"></span><br><span class="line">        downLatch.await();</span><br><span class="line">        System.out.println(<span class="string">"耗时："</span> + (System.currentTimeMillis() - startTime));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//汇总返回数据</span></span><br><span class="line">        Map&lt;String, List&lt;Integer&gt;&gt; serialNumMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; signNums.length; i++) &#123;</span><br><span class="line">            List&lt;Integer&gt; numList = serialNumMap.computeIfAbsent(signSerialNumbers[i].getGroupKey(), k -&gt; <span class="keyword">new</span> ArrayList&lt;&gt;());</span><br><span class="line">            numList.add(signNums[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//验证展示是否符合需求</span></span><br><span class="line">        serialNumMap.forEach((key, value) -&gt;&#123;</span><br><span class="line">            Set&lt;Integer&gt; set = <span class="keyword">new</span> HashSet&lt;&gt;(value);</span><br><span class="line">            <span class="keyword">assert</span> set.size() == value.size();</span><br><span class="line">            System.out.printf(<span class="string">"key:"</span> + key);</span><br><span class="line">            value.sort(Integer::compareTo);</span><br><span class="line">            System.out.println(<span class="string">" num: "</span> + value);</span><br><span class="line"></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建3个测试用例：<br>1、普通调用<br>2、多线程并发调同一条数据<br>3、多线程并发调随机调用不同数据</p>
<h4 id="redis生成流水号"><a href="#redis生成流水号" class="headerlink" title="redis生成流水号"></a>redis生成流水号</h4><p>添加redis、spring-data-redis依赖，service新增方法。<br>spring配置redis如下</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"jedisPoolConfig"</span> <span class="attr">class</span>=<span class="string">"redis.clients.jedis.JedisPoolConfig"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"jedisConnectionFactory"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">class</span>=<span class="string">"org.springframework.data.redis.connection.jedis.JedisConnectionFactory"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"hostName"</span> <span class="attr">value</span>=<span class="string">"localhost"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"port"</span> <span class="attr">value</span>=<span class="string">"6379"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"timeout"</span> <span class="attr">value</span>=<span class="string">"1800"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"poolConfig"</span> <span class="attr">ref</span>=<span class="string">"jedisPoolConfig"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"usePool"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"redisTemplate"</span> <span class="attr">class</span>=<span class="string">"org.springframework.data.redis.core.StringRedisTemplate"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"connectionFactory"</span> <span class="attr">ref</span>=<span class="string">"jedisConnectionFactory"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Long <span class="title">redisSerialNumber</span><span class="params">(SerialNumber serialNumber, <span class="keyword">final</span> <span class="keyword">int</span> inrc)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span>  (Long)redisTemplate.execute((RedisCallback&lt;Long&gt;) connection -&gt; &#123;</span><br><span class="line">        <span class="keyword">byte</span>[] keyBytes = (serialNumber.getGroupCode() + <span class="string">"_"</span> + serialNumber.getGroupKey() + <span class="string">"_"</span> + serialNumber.getScope()).getBytes();</span><br><span class="line">        Long incr = connection.incrBy(keyBytes, inrc);</span><br><span class="line">        <span class="keyword">if</span> (serialNumber.getSign().getExpire() != <span class="keyword">null</span> &amp;&amp; incr == inrc)&#123;</span><br><span class="line">            connection.expire(keyBytes, serialNumber.getSign().getExpire());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> incr;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里通过redis中<code>incrBy</code>方法对值进行递增，因为redis是单线程，所以保证线程的并发。<br>在构造key时，因为使用了scope确定了时间，当时间到下一个重新计算时，key会发生改变，计数又会从0开始。同时对</p>
<p>添加测试用例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">redisSerialNumber</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> SerialNumber serialNumber = <span class="keyword">new</span> SerialNumber(<span class="string">"ITEM"</span>, <span class="string">"1001_K000011"</span>, SerialSignEnum.D);</span><br><span class="line">    Long num = serialNumberService.redisSerialNumber(serialNumber, <span class="number">10</span>);</span><br><span class="line">    System.out.println(num);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">redisSerialNumberSingleKey</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> startTime = System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">final</span> SerialNumber serialNumber = <span class="keyword">new</span> SerialNumber(<span class="string">"ITEM"</span>, <span class="string">"1001_K00005"</span>, SerialSignEnum.D);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> incr = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> threadNum = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> threadTime = <span class="number">100</span>;</span><br><span class="line">    Thread[] threads = <span class="keyword">new</span> Thread[threadNum];</span><br><span class="line">    CountDownLatch downLatch = <span class="keyword">new</span> CountDownLatch(threadNum);</span><br><span class="line"></span><br><span class="line">    Long[] serialNums = <span class="keyword">new</span> Long[threadNum * threadTime];</span><br><span class="line">    IntStream.range(<span class="number">0</span>, threadNum).forEach((i) -&gt; threads[i] = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">        <span class="comment">//线程并发执行，返回值存入集合，空间换时间</span></span><br><span class="line">        IntStream.range(<span class="number">0</span>, threadTime).forEach((j) -&gt; serialNums[i * threadTime + j] = serialNumberService.redisSerialNumber(serialNumber, incr));</span><br><span class="line">        downLatch.countDown();</span><br><span class="line">    &#125;));</span><br><span class="line">    Arrays.stream(threads).forEach(Thread::start);</span><br><span class="line">    downLatch.await();</span><br><span class="line">    System.out.println(<span class="string">"耗时："</span> + (System.currentTimeMillis() - startTime));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//验证是否重复生成</span></span><br><span class="line">    Set&lt;Long&gt; set = <span class="keyword">new</span> HashSet&lt;&gt;(Arrays.asList(serialNums));</span><br><span class="line">    <span class="keyword">assert</span> set.size() == serialNums.length;</span><br><span class="line">    Arrays.sort(serialNums);</span><br><span class="line">    System.out.println(Arrays.toString(serialNums));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">redisSerialNumberRandomKey</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> startTime = System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> incr = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> threadNum = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> threadTime = <span class="number">10000</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> itemNum = <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> SerialNumber[] serialNumbers = <span class="keyword">new</span> SerialNumber[itemNum];</span><br><span class="line">    CountDownLatch downLatch = <span class="keyword">new</span> CountDownLatch(threadNum);</span><br><span class="line">    <span class="comment">//随机设置值</span></span><br><span class="line">    IntStream.range(<span class="number">0</span>, itemNum).forEach((i) -&gt; &#123;</span><br><span class="line">        Random random = <span class="keyword">new</span> Random();</span><br><span class="line">        DecimalFormat format = <span class="keyword">new</span> DecimalFormat(<span class="string">"00000"</span>);</span><br><span class="line">        serialNumbers[i] = <span class="keyword">new</span> SerialNumber(<span class="string">"ITEM"</span>, <span class="string">"1001_K"</span> + format.format(random.nextInt(itemNum) + <span class="number">1</span>), SerialSignEnum.D);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">//记录线程返回值</span></span><br><span class="line">    <span class="keyword">final</span> Long[] signNums = <span class="keyword">new</span> Long[threadNum * threadTime];</span><br><span class="line">    <span class="comment">//记录线程请求</span></span><br><span class="line">    <span class="keyword">final</span> SerialNumber[] signSerialNumbers = <span class="keyword">new</span> SerialNumber[threadNum * threadTime];</span><br><span class="line">    <span class="keyword">final</span> Thread[] threads = <span class="keyword">new</span> Thread[threadNum];</span><br><span class="line">    IntStream.range(<span class="number">0</span>, threadNum).forEach((i) -&gt; threads[i] = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">        IntStream.range(<span class="number">0</span>, threadTime).forEach((j) -&gt; &#123;</span><br><span class="line">            <span class="comment">//线程随机选择需要执行条件</span></span><br><span class="line">            Random random = <span class="keyword">new</span> Random();</span><br><span class="line">            SerialNumber serialNumber = serialNumbers[random.nextInt(<span class="number">20</span>)];</span><br><span class="line">            <span class="comment">//记录执行的请求、返回值</span></span><br><span class="line">            signNums[i * threadTime + j] = serialNumberService.redisSerialNumber(serialNumber, incr);</span><br><span class="line">            signSerialNumbers[i * threadTime + j] = serialNumber;</span><br><span class="line">        &#125;);</span><br><span class="line">        downLatch.countDown();</span><br><span class="line">    &#125;));</span><br><span class="line">    Arrays.stream(threads).forEach(Thread::start);</span><br><span class="line"></span><br><span class="line">    downLatch.await();</span><br><span class="line">    System.out.println(<span class="string">"耗时："</span> + (System.currentTimeMillis() - startTime));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//汇总返回数据</span></span><br><span class="line">    Map&lt;String, List&lt;Long&gt;&gt; serialNumMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; signNums.length; i++) &#123;</span><br><span class="line">        List&lt;Long&gt; numList = serialNumMap.computeIfAbsent(signSerialNumbers[i].getGroupKey(), k -&gt; <span class="keyword">new</span> ArrayList&lt;&gt;());</span><br><span class="line">        numList.add(signNums[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//验证展示是否符合需求</span></span><br><span class="line">    serialNumMap.forEach((key, value) -&gt; &#123;</span><br><span class="line">        Set&lt;Long&gt; set = <span class="keyword">new</span> HashSet&lt;&gt;(value);</span><br><span class="line">        <span class="keyword">assert</span> set.size() == value.size();</span><br><span class="line">        System.out.printf(<span class="string">"key:"</span> + key);</span><br><span class="line">        value.sort(Long::compareTo);</span><br><span class="line">        System.out.println(<span class="string">" num: "</span> + value);</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试用例和之前一样，只是调用的方法改了。</p>
<h4 id="两种流水号生成优缺点"><a href="#两种流水号生成优缺点" class="headerlink" title="两种流水号生成优缺点"></a>两种流水号生成优缺点</h4><p>mysql：使用方便，不需要而外维护其他应用，因为需要维护redis服务器比较麻烦。缺点是生成速度较慢，适合压力不大的地方。<br>redis：使用相对麻烦，需要专门维护redis服务器，优点是速度极快。</p>
<h3 id="合并两个功能"><a href="#合并两个功能" class="headerlink" title="合并两个功能"></a>合并两个功能</h3><p>需求是需要生成流水号，然后和之前业务合并插入数据库。<br>在原先的item表中添加<code>serial_num</code>字段，mappper新增插入sql <code>insertNotExist2</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> SerialNumberService serialNumberService;</span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">createItem</span><span class="params">(String skuCode, Integer num)</span></span>&#123;</span><br><span class="line">    <span class="comment">//构造流水号</span></span><br><span class="line">    SerialNumber serialNumber = <span class="keyword">new</span> SerialNumber(<span class="string">"ITEM"</span>, <span class="string">"1001"</span>, SerialSignEnum.D);</span><br><span class="line">    DecimalFormat format = <span class="keyword">new</span> DecimalFormat(<span class="string">"0000000"</span>);</span><br><span class="line">    String serialNum = serialNumber.getScope() + format.format(serialNumberService.mysqlSerialNumber(serialNumber, <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//生成插入数据</span></span><br><span class="line">    Item item = <span class="keyword">new</span> Item(skuCode, num, <span class="number">0</span>);</span><br><span class="line">    item.setSerialNum(serialNum);</span><br><span class="line">    <span class="keyword">int</span> result = itemMapper.insertNotExist2(item);</span><br><span class="line">    <span class="keyword">if</span> (result == <span class="number">0</span>)&#123;</span><br><span class="line">        Item newItem = <span class="keyword">new</span> Item(skuCode, <span class="keyword">null</span>, <span class="number">4</span>);</span><br><span class="line">        Item oldItem = <span class="keyword">new</span> Item(skuCode, <span class="keyword">null</span>, <span class="number">0</span>);</span><br><span class="line">        result = itemMapper.updateInfo(oldItem, newItem);</span><br><span class="line">        <span class="keyword">if</span> (result != <span class="number">0</span>)&#123;</span><br><span class="line">            result = itemMapper.insertNotExist2(item);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如上，先生成流水号，然后对业务数据进行插入。<br>创建单元测试如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createItem</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> threadNum = <span class="number">20</span>;</span><br><span class="line">    <span class="keyword">final</span> String skuCode = <span class="string">"K000001"</span>;</span><br><span class="line">    Thread[]threads = <span class="keyword">new</span> Thread[threadNum];</span><br><span class="line">    CountDownLatch downLatch = <span class="keyword">new</span> CountDownLatch(threadNum);</span><br><span class="line">    IntStream.range(<span class="number">0</span>, threadNum).forEach((i) -&gt; threads[i] = <span class="keyword">new</span> Thread(() -&gt;&#123;</span><br><span class="line">        itemService.createItem(skuCode, <span class="number">3</span>);</span><br><span class="line">        downLatch.countDown();</span><br><span class="line">    &#125;));</span><br><span class="line">    Arrays.stream(threads).forEach(Thread::start);</span><br><span class="line">    downLatch.await();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动20个线程，对数据库数据进行操作。</p>
<p>此处结果是一直等待，直到sql等待超时。</p>
<p>分析原因如下：<br>在之前使用数据库理解池使用的是最大20个数据库连接，因为启动了20个线程，消耗了掉了连接池中的连接，当执行到生成流水号时，因为之前流水号设置的事务传播级别是<code>Propagation.REQUIRES_NEW</code>，所以会向连接池申请新的连接，但是因为连接池中连接已经消耗完毕，只能等待连接释放，但此时连接池又全部被占用，这样互相等待导致超时发生。</p>
<p>Spring事务传播级别：<br>方法a有事务，方法b有事务</p>
<ul>
<li>REQUIRED（默认）：支持当前已经存在的事务，如果还没有事务，就创建一个新事务。</li>
<li>SUPPORTS：支持当前事务，如果没有事务那么就不在事务中运行。</li>
<li>MANDATORY：支持当前已经存在的事务，如果还没有事务，就抛出一个异常。</li>
<li>REQUIRES_NEW：挂起当前事务，创建一个新事务，如果还没有事务，就简单地创建一个新事务，和之前创建的事务无关。</li>
<li>NOT_SUPPORTED：强制不在事务中运行，如果当前存在一个事务，则挂起该事务。</li>
<li>NEVER：强制要求不在事务中运行，如果当前存在一个事务，则抛出异常。</li>
<li>NESTED：在当前事务中创建一个嵌套事务，如果还没有事务，那么就简单地创建一个新事务。和REQUIRES_NEW区别是在于，该处创建的事务和之前事务是嵌套关系，在嵌套事务提交后，如果调用方抛出异常，子事务还是会回滚。</li>
</ul>
<p>参考：<a href="http://deltamaster.is-programmer.com/posts/28489.html" target="_blank" rel="noopener">Spring事务管理中@Transactional的propagation参数</a></p>
<h4 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h4><p>修改事务传播级别为默认，这样导致的缺陷是流水号生成的事务较长，这样流水号生成速度会比较慢。采用redis生成流水号。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/04/01/2018/04/01/%E5%B7%A5%E4%BD%9C%E9%97%AE%E9%A2%98-%E5%B9%B6%E5%8F%91%E4%BA%8B%E5%8A%A1/" data-id="ck39lmv06001l4oww0bhdayp1" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BA%8B%E5%8A%A1/" rel="tag">事务</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%B7%A5%E4%BD%9C/" rel="tag">工作</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%B9%B6%E5%8F%91/" rel="tag">并发</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2018/04/04/2018/04/04/Java%E8%BF%9B%E9%98%B6-mysql%E4%BA%8B%E5%8A%A1/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Java进阶-mysql事务
        
      </div>
    </a>
  
  
    <a href="/2018/03/28/2018/03/28/Java%E8%BF%9B%E9%98%B6-Spring-Bean/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Java进阶-Spring Bean</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/ELK/">ELK</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Git/">Git</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java%E5%9F%BA%E7%A1%80/">Java基础</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Java%E5%9F%BA%E7%A1%80/NIO/">NIO</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Java%E5%9F%BA%E7%A1%80/NIO/Netty/">Netty</a></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java%E8%BF%9B%E9%98%B6/">Java进阶</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Java%E8%BF%9B%E9%98%B6/mysql/">mysql</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/MYSQL/">MYSQL</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/QT/">QT</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/QT/Tigase/">Tigase</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/RESTfull/">RESTfull</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring-Cloud/">Spring Cloud</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/SpringBoot/">SpringBoot</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Storm%E5%AD%A6%E4%B9%A0/">Storm学习</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tigase/">Tigase</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/docker/">docker</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/docker/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/feign/">feign</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/javaagent/">javaagent</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/js/">js</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/maven/">maven</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/">mysql</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/netty/">netty</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/python/selenium/">selenium</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/snake/">snake</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/sonar/">sonar</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/ssh/">ssh</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E8%B0%83%E7%94%A8%E9%93%BE/">分布式调用链</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%9F%BA%E7%A1%80%E6%90%AD%E5%BB%BA/">基础搭建</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/">基础知识</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%AD%A6%E4%B9%A0/">多线程学习</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%B7%A5%E4%BD%9C%E9%97%AE%E9%A2%98/">工作问题</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%B7%A5%E4%BD%9C%E9%97%AE%E9%A2%98/%E4%BA%8B%E5%8A%A1/">事务</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%B9%B6%E5%8F%91/">并发</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%90%9C%E7%B4%A2/">搜索</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%90%9C%E7%B4%A2/Elasticsearch/">Elasticsearch</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%94%AF%E4%BB%98/">支付</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">数据结构</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%A8%A1%E5%9D%97%E5%8C%96/">模块化</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95/">算法</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95/%E6%8E%92%E5%BA%8F/">排序</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BC%96%E7%A8%8B/">编程</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%93%BE%E8%A1%A8/">链表</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%93%BE%E8%A1%A8/%E5%B7%A5%E4%BD%9C%E6%96%B9%E6%A1%88/">工作方案</a></li></ul></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AIO/" rel="tag">AIO</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Abstract-Factory-Pattern/" rel="tag">Abstract Factory Pattern</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Adapter-Pattern/" rel="tag">Adapter Pattern</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Apache-httpclient4/" rel="tag">Apache httpclient4</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/BIO/" rel="tag">BIO</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Bean/" rel="tag">Bean</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Bridge-Pattern/" rel="tag">Bridge Pattern</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Builder-Pattern/" rel="tag">Builder Pattern</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Command-Pattern/" rel="tag">Command Pattern</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Composite-Pattern/" rel="tag">Composite Pattern</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ConcurrentHashMap/" rel="tag">ConcurrentHashMap</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Decorator-Pattern/" rel="tag">Decorator Pattern</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/" rel="tag">Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Elasticsearch/" rel="tag">Elasticsearch</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Facade-Pattern/" rel="tag">Facade Pattern</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Factory-Method-Pattern/" rel="tag">Factory Method Pattern</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Flyweight-Pattern/" rel="tag">Flyweight Pattern</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Git/" rel="tag">Git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTP%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/" rel="tag">HTTP文件上传</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hash%E4%B8%80%E8%87%B4/" rel="tag">Hash一致</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IO/" rel="tag">IO</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Interpreter-Pattern/" rel="tag">Interpreter Pattern</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Iterator-Pattern/" rel="tag">Iterator Pattern</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JMM/" rel="tag">JMM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JVM/" rel="tag">JVM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/" rel="tag">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kibana/" rel="tag">Kibana</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Logstash/" rel="tag">Logstash</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MYSQL/" rel="tag">MYSQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mediator-Pattern/" rel="tag">Mediator Pattern</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Memento-Pattern/" rel="tag">Memento Pattern</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mybatis/" rel="tag">Mybatis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NIO/" rel="tag">NIO</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Netty/" rel="tag">Netty</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OSI/" rel="tag">OSI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Observer-Pattern/" rel="tag">Observer Pattern</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Prototype-Pattern/" rel="tag">Prototype Pattern</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Proxy-Pattern/" rel="tag">Proxy-Pattern</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/QT/" rel="tag">QT</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RESTfull/" rel="tag">RESTfull</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SSM/" rel="tag">SSM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Servelt-3-0/" rel="tag">Servelt 3.0</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Singleton-Pattern/" rel="tag">Singleton Pattern</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring/" rel="tag">Spring</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring-Cloud/" rel="tag">Spring Cloud</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringBoot/" rel="tag">SpringBoot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringMVC/" rel="tag">SpringMVC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/StampedLock/" rel="tag">StampedLock</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/State-Pattern/" rel="tag">State Pattern</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Stomr%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/" rel="tag">Stomr基本概念</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Storm/" rel="tag">Storm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Storm%E5%AE%89%E8%A3%85/" rel="tag">Storm安装</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Storm%E6%9C%AC%E5%9C%B0%E8%B0%83%E7%94%A8/" rel="tag">Storm本地调用</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Storm%E6%A6%82%E5%BF%B5/" rel="tag">Storm概念</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Strategy-Pattern/" rel="tag">Strategy Pattern</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/String/" rel="tag">String</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TCP/" rel="tag">TCP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Template-Method-Pattern/" rel="tag">Template Method Pattern</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tigase/" rel="tag">Tigase</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tigase%E6%8F%92%E4%BB%B6/" rel="tag">Tigase插件</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tigase%E7%BB%84%E4%BB%B6/" rel="tag">Tigase组件</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/UDP/" rel="tag">UDP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/VPC%E4%BA%92%E9%80%9A/" rel="tag">VPC互通</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Visitor-Pattern/" rel="tag">Visitor Pattern</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/agent/" rel="tag">agent</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ajax/" rel="tag">ajax</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/archetypes/" rel="tag">archetypes</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/classLoader/" rel="tag">classLoader</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fastdfs/" rel="tag">fastdfs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/feign/" rel="tag">feign</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/javaagent/" rel="tag">javaagent</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jenkins/" rel="tag">jenkins</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jetty9-LoginService-port/" rel="tag">jetty9 LoginService  port</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/lambda/" rel="tag">lambda</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/maven/" rel="tag">maven</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/" rel="tag">mysql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql%E6%90%9C%E7%B4%A2/" rel="tag">mysql搜索</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/netty/" rel="tag">netty</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/selenium/" rel="tag">selenium</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/snake/" rel="tag">snake</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sonar/" rel="tag">sonar</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/springMVC/" rel="tag">springMVC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ssh/" rel="tag">ssh</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/swagger/" rel="tag">swagger</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/synchronized/" rel="tag">synchronized</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tcp/" rel="tag">tcp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tigase/" rel="tag">tigase</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tomcat/" rel="tag">tomcat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/volatile/" rel="tag">volatile</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%AD%E4%BB%8B%E8%80%85%E6%A8%A1%E5%BC%8F/" rel="tag">中介者模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BA%8B%E5%8A%A1/" rel="tag">事务</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BA%8C%E5%8F%89%E6%A0%91/" rel="tag">二叉树</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BA%AB%E5%85%83%E6%A8%A1%E5%BC%8F/" rel="tag">享元模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F/" rel="tag">代理模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BB%A3%E7%A0%81%E8%B4%A8%E9%87%8F/" rel="tag">代码质量</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BC%98%E5%8C%96/" rel="tag">优化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%85%A8%E6%8E%92%E5%88%97/" rel="tag">全排列</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/" rel="tag">内存模型</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F/" rel="tag">内网穿透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%86%92%E6%B3%A1%E6%8E%92%E5%BA%8F/" rel="tag">冒泡排序</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%88%86%E5%8C%BA/" rel="tag">分区</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%88%86%E5%BA%93/" rel="tag">分库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%88%86%E8%A1%A8/" rel="tag">分表</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/" rel="tag">单例模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8E%9F%E5%9E%8B%E6%A8%A1%E5%BC%8F/" rel="tag">原型模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86/" rel="tag">反向代理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%90%8C%E6%AD%A5/" rel="tag">同步</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%91%BD%E4%BB%A4%E6%A8%A1%E5%BC%8F/" rel="tag">命令模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%93%88%E5%B8%8C%E8%A1%A8/" rel="tag">哈希表</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9B%BE%E7%89%87%E6%9C%8D%E5%8A%A1%E5%99%A8/" rel="tag">图片服务器</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9F%BA%E6%9C%AC%E7%B1%BB%E5%9E%8B/" rel="tag">基本类型</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9F%BA%E7%A1%80/" rel="tag">基础</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9F%BA%E7%A1%80%E6%90%AD%E5%BB%BA/" rel="tag">基础搭建</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A0%86%E6%8E%92%E5%BA%8F/" rel="tag">堆排序</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%87%E5%BF%98%E5%BD%95%E6%A8%A1%E5%BC%8F/" rel="tag">备忘录模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%96%E8%A7%82%E6%A8%A1%E5%BC%8F/" rel="tag">外观模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" rel="tag">多线程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B7%A5%E4%BD%9C/" rel="tag">工作</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B7%A5%E5%85%B7%E7%B1%BB/" rel="tag">工具类</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B7%A5%E5%8E%82%E6%96%B9%E6%B3%95/" rel="tag">工厂方法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B9%B6%E5%8F%91/" rel="tag">并发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B9%B6%E5%8F%91%E4%BF%AE%E6%94%B9/" rel="tag">并发修改</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B9%B6%E5%8F%91%E5%90%8C%E6%AD%A5/" rel="tag">并发同步</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8/" rel="tag">并发容器</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B9%B6%E5%BD%92%E6%8E%92%E5%BA%8F/" rel="tag">并归排序</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BA%8F%E5%88%97%E5%8C%96/" rel="tag">序列化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BB%BA%E9%80%A0%E8%80%85%E6%A8%A1%E5%BC%8F/" rel="tag">建造者模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BC%82%E5%B8%B8/" rel="tag">异常</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7/" rel="tag">微信公众号</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98/" rel="tag">微信支付</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BF%AB%E9%80%9F%E6%8E%92%E5%BA%8F/" rel="tag">快速排序</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BA%E9%A1%B9%E7%9B%AE/" rel="tag">快速搭建项目</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%8A%BD%E8%B1%A1%E5%B7%A5%E5%8E%82/" rel="tag">抽象工厂</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%8B%86%E5%8C%85/" rel="tag">拆包</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%8F%92%E5%85%A5%E6%8E%92%E5%BA%8F/" rel="tag">插入排序</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%97%A5%E5%BF%97%E6%9F%A5%E8%AF%A2/" rel="tag">日志查询</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9C%89%E5%BA%8F%E9%93%BE%E8%A1%A8/" rel="tag">有序链表</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9E%9A%E4%B8%BE/" rel="tag">枚举</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%A1%A5%E6%8E%A5%E6%A8%A1%E5%BC%8F/" rel="tag">桥接模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%A8%A1%E5%9D%97%E5%8C%96%E5%BC%80%E5%8F%91/" rel="tag">模块化开发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%A8%A1%E6%9D%BF%E6%96%B9%E6%B3%95/" rel="tag">模板方法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B5%8B%E8%AF%95/" rel="tag">测试</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%8A%B6%E6%80%81%E6%A8%A1%E5%BC%8F/" rel="tag">状态模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F/" rel="tag">策略模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%AE%97%E6%B3%95/" rel="tag">算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%B1%BB%E5%8A%A0%E8%BD%BD/" rel="tag">类加载</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%B2%98%E5%8C%85/" rel="tag">粘包</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BA%BF%E7%A8%8B%E6%B1%A0/" rel="tag">线程池</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BB%84%E5%90%88%E6%A8%A1%E5%BC%8F/" rel="tag">组合模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" rel="tag">网络编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%81%8C%E8%B4%A3%E9%93%BE%E6%A8%A1%E5%BC%8F/" rel="tag">职责链模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%81%8C%E8%B4%A3%E9%93%BE%E6%A8%A1%E5%BC%8F%EF%BC%88Chain-of-Responsibility-Pattern%EF%BC%89/" rel="tag">职责链模式（Chain of Responsibility Pattern）</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%84%9A%E6%89%8B%E6%9E%B6/" rel="tag">脚手架</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%A3%85%E9%A5%B0%E6%A8%A1%E5%BC%8F/" rel="tag">装饰模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F/" rel="tag">观察者模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%A7%A3%E9%87%8A%E5%99%A8%E6%A8%A1%E5%BC%8F/" rel="tag">解释器模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%BF%E9%97%AE%E8%80%85%E6%A8%A1%E5%BC%8F/" rel="tag">访问者模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AF%AD%E6%B3%95%E7%B3%96/" rel="tag">语法糖</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AF%BB%E5%86%99%E9%94%81/" rel="tag">读写锁</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%B0%83%E7%94%A8%E6%A0%88/" rel="tag">调用栈</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%B0%83%E7%94%A8%E9%93%BE/" rel="tag">调用链</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%B7%A8%E5%9F%9F/" rel="tag">跨域</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%BF%90%E8%A1%8C%E6%97%B6%E9%97%B4/" rel="tag">运行时间</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%BF%9B%E9%98%B6/" rel="tag">进阶</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%BF%AD%E4%BB%A3%E5%99%A8%E6%A8%A1%E5%BC%8F/" rel="tag">迭代器模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%80%82%E9%85%8D%E5%99%A8%E6%A8%A1%E5%BC%8F/" rel="tag">适配器模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%80%89%E6%8B%A9%E6%8E%92%E5%BA%8F/" rel="tag">选择排序</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%83%A8%E7%BD%B2/" rel="tag">部署</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%93%BE%E8%A1%A8/" rel="tag">链表</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%93%BE%E8%A1%A8%E7%BF%BB%E8%BD%AC/" rel="tag">链表翻转</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%94%81/" rel="tag">锁</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%98%BF%E9%87%8C%E4%BA%91/" rel="tag">阿里云</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99/" rel="tag">面向对象设计原则</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/AIO/" style="font-size: 10px;">AIO</a> <a href="/tags/Abstract-Factory-Pattern/" style="font-size: 10px;">Abstract Factory Pattern</a> <a href="/tags/Adapter-Pattern/" style="font-size: 10px;">Adapter Pattern</a> <a href="/tags/Apache-httpclient4/" style="font-size: 10px;">Apache httpclient4</a> <a href="/tags/BIO/" style="font-size: 10px;">BIO</a> <a href="/tags/Bean/" style="font-size: 10px;">Bean</a> <a href="/tags/Bridge-Pattern/" style="font-size: 10px;">Bridge Pattern</a> <a href="/tags/Builder-Pattern/" style="font-size: 10px;">Builder Pattern</a> <a href="/tags/Command-Pattern/" style="font-size: 10px;">Command Pattern</a> <a href="/tags/Composite-Pattern/" style="font-size: 10px;">Composite Pattern</a> <a href="/tags/ConcurrentHashMap/" style="font-size: 10px;">ConcurrentHashMap</a> <a href="/tags/Decorator-Pattern/" style="font-size: 10px;">Decorator Pattern</a> <a href="/tags/Docker/" style="font-size: 11.67px;">Docker</a> <a href="/tags/Elasticsearch/" style="font-size: 11.67px;">Elasticsearch</a> <a href="/tags/Facade-Pattern/" style="font-size: 10px;">Facade Pattern</a> <a href="/tags/Factory-Method-Pattern/" style="font-size: 10px;">Factory Method Pattern</a> <a href="/tags/Flyweight-Pattern/" style="font-size: 10px;">Flyweight Pattern</a> <a href="/tags/Git/" style="font-size: 10px;">Git</a> <a href="/tags/HTTP%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/" style="font-size: 10px;">HTTP文件上传</a> <a href="/tags/Hash%E4%B8%80%E8%87%B4/" style="font-size: 10px;">Hash一致</a> <a href="/tags/IO/" style="font-size: 10px;">IO</a> <a href="/tags/Interpreter-Pattern/" style="font-size: 10px;">Interpreter Pattern</a> <a href="/tags/Iterator-Pattern/" style="font-size: 10px;">Iterator Pattern</a> <a href="/tags/JMM/" style="font-size: 10px;">JMM</a> <a href="/tags/JVM/" style="font-size: 10px;">JVM</a> <a href="/tags/Java/" style="font-size: 10px;">Java</a> <a href="/tags/Kibana/" style="font-size: 11.67px;">Kibana</a> <a href="/tags/Logstash/" style="font-size: 11.67px;">Logstash</a> <a href="/tags/MYSQL/" style="font-size: 10px;">MYSQL</a> <a href="/tags/Mediator-Pattern/" style="font-size: 10px;">Mediator Pattern</a> <a href="/tags/Memento-Pattern/" style="font-size: 10px;">Memento Pattern</a> <a href="/tags/Mybatis/" style="font-size: 10px;">Mybatis</a> <a href="/tags/NIO/" style="font-size: 10px;">NIO</a> <a href="/tags/Netty/" style="font-size: 10px;">Netty</a> <a href="/tags/OSI/" style="font-size: 10px;">OSI</a> <a href="/tags/Observer-Pattern/" style="font-size: 10px;">Observer Pattern</a> <a href="/tags/Prototype-Pattern/" style="font-size: 10px;">Prototype Pattern</a> <a href="/tags/Proxy-Pattern/" style="font-size: 10px;">Proxy-Pattern</a> <a href="/tags/QT/" style="font-size: 10px;">QT</a> <a href="/tags/RESTfull/" style="font-size: 10px;">RESTfull</a> <a href="/tags/SSM/" style="font-size: 10px;">SSM</a> <a href="/tags/Servelt-3-0/" style="font-size: 10px;">Servelt 3.0</a> <a href="/tags/Singleton-Pattern/" style="font-size: 10px;">Singleton Pattern</a> <a href="/tags/Spring/" style="font-size: 13.33px;">Spring</a> <a href="/tags/Spring-Cloud/" style="font-size: 10px;">Spring Cloud</a> <a href="/tags/SpringBoot/" style="font-size: 10px;">SpringBoot</a> <a href="/tags/SpringMVC/" style="font-size: 10px;">SpringMVC</a> <a href="/tags/StampedLock/" style="font-size: 10px;">StampedLock</a> <a href="/tags/State-Pattern/" style="font-size: 10px;">State Pattern</a> <a href="/tags/Stomr%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/" style="font-size: 10px;">Stomr基本概念</a> <a href="/tags/Storm/" style="font-size: 13.33px;">Storm</a> <a href="/tags/Storm%E5%AE%89%E8%A3%85/" style="font-size: 10px;">Storm安装</a> <a href="/tags/Storm%E6%9C%AC%E5%9C%B0%E8%B0%83%E7%94%A8/" style="font-size: 10px;">Storm本地调用</a> <a href="/tags/Storm%E6%A6%82%E5%BF%B5/" style="font-size: 10px;">Storm概念</a> <a href="/tags/Strategy-Pattern/" style="font-size: 10px;">Strategy Pattern</a> <a href="/tags/String/" style="font-size: 10px;">String</a> <a href="/tags/TCP/" style="font-size: 10px;">TCP</a> <a href="/tags/Template-Method-Pattern/" style="font-size: 10px;">Template Method Pattern</a> <a href="/tags/Tigase/" style="font-size: 11.67px;">Tigase</a> <a href="/tags/Tigase%E6%8F%92%E4%BB%B6/" style="font-size: 10px;">Tigase插件</a> <a href="/tags/Tigase%E7%BB%84%E4%BB%B6/" style="font-size: 10px;">Tigase组件</a> <a href="/tags/UDP/" style="font-size: 10px;">UDP</a> <a href="/tags/VPC%E4%BA%92%E9%80%9A/" style="font-size: 10px;">VPC互通</a> <a href="/tags/Visitor-Pattern/" style="font-size: 10px;">Visitor Pattern</a> <a href="/tags/agent/" style="font-size: 10px;">agent</a> <a href="/tags/ajax/" style="font-size: 10px;">ajax</a> <a href="/tags/archetypes/" style="font-size: 10px;">archetypes</a> <a href="/tags/classLoader/" style="font-size: 11.67px;">classLoader</a> <a href="/tags/docker/" style="font-size: 13.33px;">docker</a> <a href="/tags/fastdfs/" style="font-size: 10px;">fastdfs</a> <a href="/tags/feign/" style="font-size: 10px;">feign</a> <a href="/tags/java/" style="font-size: 10px;">java</a> <a href="/tags/javaagent/" style="font-size: 10px;">javaagent</a> <a href="/tags/jenkins/" style="font-size: 10px;">jenkins</a> <a href="/tags/jetty9-LoginService-port/" style="font-size: 10px;">jetty9 LoginService  port</a> <a href="/tags/lambda/" style="font-size: 10px;">lambda</a> <a href="/tags/maven/" style="font-size: 10px;">maven</a> <a href="/tags/mysql/" style="font-size: 10px;">mysql</a> <a href="/tags/mysql%E6%90%9C%E7%B4%A2/" style="font-size: 10px;">mysql搜索</a> <a href="/tags/netty/" style="font-size: 10px;">netty</a> <a href="/tags/python/" style="font-size: 10px;">python</a> <a href="/tags/selenium/" style="font-size: 10px;">selenium</a> <a href="/tags/snake/" style="font-size: 10px;">snake</a> <a href="/tags/sonar/" style="font-size: 10px;">sonar</a> <a href="/tags/springMVC/" style="font-size: 10px;">springMVC</a> <a href="/tags/ssh/" style="font-size: 10px;">ssh</a> <a href="/tags/swagger/" style="font-size: 10px;">swagger</a> <a href="/tags/synchronized/" style="font-size: 10px;">synchronized</a> <a href="/tags/tcp/" style="font-size: 10px;">tcp</a> <a href="/tags/tigase/" style="font-size: 10px;">tigase</a> <a href="/tags/tomcat/" style="font-size: 10px;">tomcat</a> <a href="/tags/volatile/" style="font-size: 10px;">volatile</a> <a href="/tags/%E4%B8%AD%E4%BB%8B%E8%80%85%E6%A8%A1%E5%BC%8F/" style="font-size: 10px;">中介者模式</a> <a href="/tags/%E4%BA%8B%E5%8A%A1/" style="font-size: 11.67px;">事务</a> <a href="/tags/%E4%BA%8C%E5%8F%89%E6%A0%91/" style="font-size: 10px;">二叉树</a> <a href="/tags/%E4%BA%AB%E5%85%83%E6%A8%A1%E5%BC%8F/" style="font-size: 10px;">享元模式</a> <a href="/tags/%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F/" style="font-size: 10px;">代理模式</a> <a href="/tags/%E4%BB%A3%E7%A0%81%E8%B4%A8%E9%87%8F/" style="font-size: 10px;">代码质量</a> <a href="/tags/%E4%BC%98%E5%8C%96/" style="font-size: 11.67px;">优化</a> <a href="/tags/%E5%85%A8%E6%8E%92%E5%88%97/" style="font-size: 10px;">全排列</a> <a href="/tags/%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/" style="font-size: 10px;">内存模型</a> <a href="/tags/%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F/" style="font-size: 10px;">内网穿透</a> <a href="/tags/%E5%86%92%E6%B3%A1%E6%8E%92%E5%BA%8F/" style="font-size: 10px;">冒泡排序</a> <a href="/tags/%E5%88%86%E5%8C%BA/" style="font-size: 10px;">分区</a> <a href="/tags/%E5%88%86%E5%BA%93/" style="font-size: 10px;">分库</a> <a href="/tags/%E5%88%86%E8%A1%A8/" style="font-size: 10px;">分表</a> <a href="/tags/%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/" style="font-size: 10px;">单例模式</a> <a href="/tags/%E5%8E%9F%E5%9E%8B%E6%A8%A1%E5%BC%8F/" style="font-size: 10px;">原型模式</a> <a href="/tags/%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86/" style="font-size: 10px;">反向代理</a> <a href="/tags/%E5%90%8C%E6%AD%A5/" style="font-size: 15px;">同步</a> <a href="/tags/%E5%91%BD%E4%BB%A4%E6%A8%A1%E5%BC%8F/" style="font-size: 10px;">命令模式</a> <a href="/tags/%E5%93%88%E5%B8%8C%E8%A1%A8/" style="font-size: 10px;">哈希表</a> <a href="/tags/%E5%9B%BE%E7%89%87%E6%9C%8D%E5%8A%A1%E5%99%A8/" style="font-size: 10px;">图片服务器</a> <a href="/tags/%E5%9F%BA%E6%9C%AC%E7%B1%BB%E5%9E%8B/" style="font-size: 10px;">基本类型</a> <a href="/tags/%E5%9F%BA%E7%A1%80/" style="font-size: 18.33px;">基础</a> <a href="/tags/%E5%9F%BA%E7%A1%80%E6%90%AD%E5%BB%BA/" style="font-size: 10px;">基础搭建</a> <a href="/tags/%E5%A0%86%E6%8E%92%E5%BA%8F/" style="font-size: 10px;">堆排序</a> <a href="/tags/%E5%A4%87%E5%BF%98%E5%BD%95%E6%A8%A1%E5%BC%8F/" style="font-size: 10px;">备忘录模式</a> <a href="/tags/%E5%A4%96%E8%A7%82%E6%A8%A1%E5%BC%8F/" style="font-size: 10px;">外观模式</a> <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size: 16.67px;">多线程</a> <a href="/tags/%E5%B7%A5%E4%BD%9C/" style="font-size: 10px;">工作</a> <a href="/tags/%E5%B7%A5%E5%85%B7%E7%B1%BB/" style="font-size: 10px;">工具类</a> <a href="/tags/%E5%B7%A5%E5%8E%82%E6%96%B9%E6%B3%95/" style="font-size: 10px;">工厂方法</a> <a href="/tags/%E5%B9%B6%E5%8F%91/" style="font-size: 10px;">并发</a> <a href="/tags/%E5%B9%B6%E5%8F%91%E4%BF%AE%E6%94%B9/" style="font-size: 10px;">并发修改</a> <a href="/tags/%E5%B9%B6%E5%8F%91%E5%90%8C%E6%AD%A5/" style="font-size: 10px;">并发同步</a> <a href="/tags/%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8/" style="font-size: 10px;">并发容器</a> <a href="/tags/%E5%B9%B6%E5%BD%92%E6%8E%92%E5%BA%8F/" style="font-size: 10px;">并归排序</a> <a href="/tags/%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 10px;">序列化</a> <a href="/tags/%E5%BB%BA%E9%80%A0%E8%80%85%E6%A8%A1%E5%BC%8F/" style="font-size: 10px;">建造者模式</a> <a href="/tags/%E5%BC%82%E5%B8%B8/" style="font-size: 10px;">异常</a> <a href="/tags/%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7/" style="font-size: 10px;">微信公众号</a> <a href="/tags/%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98/" style="font-size: 10px;">微信支付</a> <a href="/tags/%E5%BF%AB%E9%80%9F%E6%8E%92%E5%BA%8F/" style="font-size: 10px;">快速排序</a> <a href="/tags/%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BA%E9%A1%B9%E7%9B%AE/" style="font-size: 10px;">快速搭建项目</a> <a href="/tags/%E6%8A%BD%E8%B1%A1%E5%B7%A5%E5%8E%82/" style="font-size: 10px;">抽象工厂</a> <a href="/tags/%E6%8B%86%E5%8C%85/" style="font-size: 10px;">拆包</a> <a href="/tags/%E6%8F%92%E5%85%A5%E6%8E%92%E5%BA%8F/" style="font-size: 10px;">插入排序</a> <a href="/tags/%E6%97%A5%E5%BF%97%E6%9F%A5%E8%AF%A2/" style="font-size: 10px;">日志查询</a> <a href="/tags/%E6%9C%89%E5%BA%8F%E9%93%BE%E8%A1%A8/" style="font-size: 10px;">有序链表</a> <a href="/tags/%E6%9E%9A%E4%B8%BE/" style="font-size: 10px;">枚举</a> <a href="/tags/%E6%A1%A5%E6%8E%A5%E6%A8%A1%E5%BC%8F/" style="font-size: 10px;">桥接模式</a> <a href="/tags/%E6%A8%A1%E5%9D%97%E5%8C%96%E5%BC%80%E5%8F%91/" style="font-size: 10px;">模块化开发</a> <a href="/tags/%E6%A8%A1%E6%9D%BF%E6%96%B9%E6%B3%95/" style="font-size: 10px;">模板方法</a> <a href="/tags/%E6%B5%8B%E8%AF%95/" style="font-size: 10px;">测试</a> <a href="/tags/%E7%8A%B6%E6%80%81%E6%A8%A1%E5%BC%8F/" style="font-size: 10px;">状态模式</a> <a href="/tags/%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F/" style="font-size: 10px;">策略模式</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 10px;">算法</a> <a href="/tags/%E7%B1%BB%E5%8A%A0%E8%BD%BD/" style="font-size: 10px;">类加载</a> <a href="/tags/%E7%B2%98%E5%8C%85/" style="font-size: 10px;">粘包</a> <a href="/tags/%E7%BA%BF%E7%A8%8B%E6%B1%A0/" style="font-size: 10px;">线程池</a> <a href="/tags/%E7%BB%84%E5%90%88%E6%A8%A1%E5%BC%8F/" style="font-size: 10px;">组合模式</a> <a href="/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" style="font-size: 10px;">网络编程</a> <a href="/tags/%E8%81%8C%E8%B4%A3%E9%93%BE%E6%A8%A1%E5%BC%8F/" style="font-size: 10px;">职责链模式</a> <a href="/tags/%E8%81%8C%E8%B4%A3%E9%93%BE%E6%A8%A1%E5%BC%8F%EF%BC%88Chain-of-Responsibility-Pattern%EF%BC%89/" style="font-size: 10px;">职责链模式（Chain of Responsibility Pattern）</a> <a href="/tags/%E8%84%9A%E6%89%8B%E6%9E%B6/" style="font-size: 10px;">脚手架</a> <a href="/tags/%E8%A3%85%E9%A5%B0%E6%A8%A1%E5%BC%8F/" style="font-size: 10px;">装饰模式</a> <a href="/tags/%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F/" style="font-size: 10px;">观察者模式</a> <a href="/tags/%E8%A7%A3%E9%87%8A%E5%99%A8%E6%A8%A1%E5%BC%8F/" style="font-size: 10px;">解释器模式</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 20px;">设计模式</a> <a href="/tags/%E8%AE%BF%E9%97%AE%E8%80%85%E6%A8%A1%E5%BC%8F/" style="font-size: 10px;">访问者模式</a> <a href="/tags/%E8%AF%AD%E6%B3%95%E7%B3%96/" style="font-size: 10px;">语法糖</a> <a href="/tags/%E8%AF%BB%E5%86%99%E9%94%81/" style="font-size: 10px;">读写锁</a> <a href="/tags/%E8%B0%83%E7%94%A8%E6%A0%88/" style="font-size: 10px;">调用栈</a> <a href="/tags/%E8%B0%83%E7%94%A8%E9%93%BE/" style="font-size: 10px;">调用链</a> <a href="/tags/%E8%B7%A8%E5%9F%9F/" style="font-size: 10px;">跨域</a> <a href="/tags/%E8%BF%90%E8%A1%8C%E6%97%B6%E9%97%B4/" style="font-size: 10px;">运行时间</a> <a href="/tags/%E8%BF%9B%E9%98%B6/" style="font-size: 10px;">进阶</a> <a href="/tags/%E8%BF%AD%E4%BB%A3%E5%99%A8%E6%A8%A1%E5%BC%8F/" style="font-size: 10px;">迭代器模式</a> <a href="/tags/%E9%80%82%E9%85%8D%E5%99%A8%E6%A8%A1%E5%BC%8F/" style="font-size: 10px;">适配器模式</a> <a href="/tags/%E9%80%89%E6%8B%A9%E6%8E%92%E5%BA%8F/" style="font-size: 10px;">选择排序</a> <a href="/tags/%E9%83%A8%E7%BD%B2/" style="font-size: 10px;">部署</a> <a href="/tags/%E9%93%BE%E8%A1%A8/" style="font-size: 10px;">链表</a> <a href="/tags/%E9%93%BE%E8%A1%A8%E7%BF%BB%E8%BD%AC/" style="font-size: 10px;">链表翻转</a> <a href="/tags/%E9%94%81/" style="font-size: 10px;">锁</a> <a href="/tags/%E9%98%BF%E9%87%8C%E4%BA%91/" style="font-size: 10px;">阿里云</a> <a href="/tags/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99/" style="font-size: 10px;">面向对象设计原则</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">April 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/02/">February 2015</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/01/04/2019/01/04/snake-agent%E6%8B%A6%E6%88%AA%E5%8F%8A%E6%97%A5%E5%BF%97%E8%BE%93%E5%87%BA/">snake-agent拦截及日志输出</a>
          </li>
        
          <li>
            <a href="/2018/12/27/2018/12/27/snake-agent%E5%88%9D%E6%AD%A5%E6%90%AD%E5%BB%BA/">snake-agent初步搭建</a>
          </li>
        
          <li>
            <a href="/2018/12/25/2018/12/25/%E5%B9%B6%E5%8F%91%E4%BC%98%E5%8C%96%E8%AE%B0%E5%BD%95/">并发优化记录</a>
          </li>
        
          <li>
            <a href="/2018/07/04/2018/07/04/docker%E6%90%AD%E5%BB%BAfastdfs/">docker搭建fastdfs</a>
          </li>
        
          <li>
            <a href="/2018/05/04/2018/05/04/%E7%AE%97%E6%B3%95%E5%9B%BE%E8%A7%A3-%E5%B8%B8%E7%94%A8%E6%8E%92%E5%BA%8F/">算法图解-常用排序</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>